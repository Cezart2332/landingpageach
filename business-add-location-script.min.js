document.addEventListener("DOMContentLoaded",()=>{const e=document.getElementById("addLocationForm"),t=document.getElementById("name"),a=document.getElementById("nameError"),n=document.getElementById("address"),o=document.getElementById("phone"),i=document.getElementById("description"),r=document.getElementById("tags"),l=document.getElementById("tagsPreview"),s=document.getElementById("categories"),c=document.getElementById("reservationsToggle"),d=document.getElementById("submitBtn"),u=document.getElementById("geoStatus"),p=document.getElementById("photoArea"),m=document.getElementById("photoInput");let f,g=null,v="",y=[],h=null;const b={lat:null,lng:null,loading:!1},E=["restaurant","pub","cafenea","club"];function escapeHtml(e){return String(e).replace(/[&<>"']/g,e=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;"}[e]))}function setSubmit(e,t){d&&(d.innerHTML=e,d.disabled=!!t)}function renderTags(){l.innerHTML=y.map(e=>`<span class="tag-chip">${escapeHtml(e)}<button type="button" data-del="${escapeHtml(e)}">×</button></span>`).join(""),l.querySelectorAll("[data-del]").forEach(e=>e.addEventListener("click",()=>{y=y.filter(t=>t!==e.dataset.del),renderTags(),validate()}))}function handlePhoto(){const e=m.files&&m.files[0];if(!e)return;h=e;const t=URL.createObjectURL(e);p.innerHTML=`<img src="${t}" class="photo-preview" alt="preview"/><button type="button" class="remove-photo" id="removePhoto">Elimină fotografia</button>`;const a=document.getElementById("removePhoto");a&&a.addEventListener("click",()=>{h=null,m.value="",p.innerHTML='<i class="fas fa-camera" style="font-size:2rem;color:#a855f7;"></i><p style="margin:10px 0 4px;font-weight:600;color:#a855f7;">Adaugă o fotografie</p><p style="margin:0;color:#64748b;font-size:.7rem;">Click sau trage o imagine (16:9 recomandat)</p><input type="file" id="photoInput" accept="image/*" style="display:none;" />',document.getElementById("photoInput").addEventListener("change",handlePhoto)})}function updateGeoStatus(){u&&(b.loading?u.innerHTML='<div class="geo-status geo-loading"><i class="fas fa-hourglass-half"></i> Obțin coordonate...</div>':b.lat&&b.lng?u.innerHTML=`<div class="geo-status geo-ok"><i class="fas fa-check-circle"></i> Localizat: ${b.lat}, ${b.lng}</div>`:n.value.trim().length>=5?u.innerHTML='<div class="geo-status geo-loading" style="background:rgba(239,68,68,.1);border-color:rgba(239,68,68,.4);color:#ef4444;"><i class="fas fa-triangle-exclamation"></i> Nu s-au putut obține coordonatele</div>':u.innerHTML="")}function validate(){let e=!0;return t.value.trim()?(t.classList.remove("error"),a.style.display="none"):(t.classList.add("error"),a.style.display="block",a.textContent="Introdu numele locației.",e=!1),n.value.trim()&&b.lat&&b.lng||(e=!1),o.value.trim()||(e=!1),v||(e=!1),d&&(d.disabled=!e),e}async function safeProfile(){try{return await window.SecureApiService.getProfile()}catch(e){return null}}function extractCompanyId(e){return e&&(e.id||e.Id||e.companyId||e.CompanyId||e.company&&(e.company.id||e.company.Id))||null}s&&(s.innerHTML=E.map(e=>`<button type="button" class="cat-pill" data-cat="${e}">${e}</button>`).join(""),s.querySelectorAll(".cat-pill").forEach(e=>{e.addEventListener("click",()=>{v=e.dataset.cat,s.querySelectorAll(".cat-pill").forEach(t=>t.classList.toggle("active",t===e)),validate()})})),r&&(r.addEventListener("input",()=>{const e=r.value;e.includes(",")&&(e.split(",").map(e=>e.trim()).filter(Boolean).forEach(e=>{!y.includes(e)&&y.length<50&&y.push(e)}),r.value="",renderTags(),validate())}),r.addEventListener("keydown",e=>{if("Enter"===e.key){e.preventDefault();const t=r.value.trim();t&&(y.includes(t)||y.push(t),r.value="",renderTags(),validate())}"Backspace"!==e.key||r.value||(y.pop(),renderTags(),validate())})),p&&p.addEventListener("click",()=>m.click()),m&&m.addEventListener("change",handlePhoto),p&&(p.addEventListener("dragover",e=>{e.preventDefault(),p.style.borderColor="#a855f7"}),p.addEventListener("dragleave",()=>p.style.borderColor="rgba(139,92,246,.3)"),p.addEventListener("drop",e=>{e.preventDefault(),p.style.borderColor="rgba(139,92,246,.3)",e.dataTransfer.files[0]&&(m.files=e.dataTransfer.files,handlePhoto())})),n&&n.addEventListener("input",()=>{f&&clearTimeout(f);const e=n.value.trim();if(e.length<5)return b.lat=null,b.lng=null,updateGeoStatus(),void validate();f=setTimeout(()=>{return t=e,b.loading=!0,updateGeoStatus(),void fetch(`https://api.geoapify.com/v1/geocode/search?text=${encodeURIComponent(t+", Romania")}&limit=1&lang=ro&filter=countrycode:ro&apiKey=d5466dbfa4a84344b872af4009106e17`).then(e=>e.json()).then(e=>{const t=e.features&&e.features[0];if(t){const[e,a]=t.geometry.coordinates;b.lat=Number(a).toFixed(6),b.lng=Number(e).toFixed(6)}else b.lat=null,b.lng=null}).catch(()=>{b.lat=null,b.lng=null}).finally(()=>{b.loading=!1,updateGeoStatus(),validate()});var t},650)}),["input","blur"].forEach(e=>t.addEventListener(e,validate)),o&&o.addEventListener("input",validate),i&&i.addEventListener("input",validate),e&&e.addEventListener("submit",async e=>{if(e.preventDefault(),validate()){setSubmit('<i class="fas fa-spinner fa-spin"></i> Creare...',!0);try{if(!g){const e=await safeProfile();g=extractCompanyId(e)}if(!g)throw new Error("Nu s-a putut identifica compania.");const e=t.value.trim(),r=await async function(e,t){try{const a=await window.SecureApiService.get(`/companies/${e}/locations`);return(a&&a.success&&Array.isArray(a.data)?a.data:Array.isArray(a)?a:[]).some(e=>(e.name||e.Name||"").toLowerCase()===t.toLowerCase())}catch(e){return console.warn("Name check failed:",e),!1}}(g,e);if(r)return a.style.display="block",a.textContent="O locație cu acest nume există deja. Alege un nume diferit.",alert("Nume Locație Duplicat: O locație cu acest nume există deja pentru compania ta."),void setSubmit('<i class="fas fa-plus-circle"></i> Creează Locație',!1);const l=Number(b.lat),s=Number(b.lng);if(!Number.isFinite(l)||!Number.isFinite(s))return alert("Coordonatele nu sunt valide. Reintrodu adresa."),void setSubmit('<i class="fas fa-plus-circle"></i> Creează Locație',!1);const d=new FormData;d.append("name",e),d.append("address",n.value.trim()),d.append("category",v),d.append("phoneNumber",o.value.trim()),d.append("latitude",l.toFixed(6)),d.append("longitude",s.toFixed(6)),d.append("tags",y.join(", ")),d.append("description",i.value||""),d.append("reservationsEnabled",c.checked?"true":"false"),h&&d.append("photo",h,h.name||"location_photo.jpg");const u=await window.SecureApiService.post(`/companies/${g}/locations`,d);if(u&&u.success)return alert("Locația a fost adăugată cu succes!"),void(window.location.href="business-locations.html");let p="Adăugarea locației a eșuat";if(u&&u.error&&(p=u.error?.detail||u.error?.Error||u.error?.message||p,409===u.status))return alert("Nume Locație Duplicat: "+p),void setSubmit('<i class="fas fa-plus-circle"></i> Creează Locație',!1);alert(p),setSubmit('<i class="fas fa-plus-circle"></i> Creează Locație',!1)}catch(e){console.error("Create location error:",e),alert("Eroare: adăugarea locației a eșuat"),setSubmit('<i class="fas fa-plus-circle"></i> Creează Locație',!1)}}}),async function(){try{const e=await safeProfile();g=extractCompanyId(e)}catch{}}(),validate()});