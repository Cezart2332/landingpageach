document.addEventListener("DOMContentLoaded",()=>{const e=document.getElementById("locationContent"),t=new URLSearchParams(location.search).get("id");if(!t)return void(e&&(e.innerHTML='<p style="color:#ef4444;font-weight:600;">ID locație lipsă.</p>'));const i={location:null,hours:[],reservations:[],loading:!0};function showError(t){if(!e)return;e.innerHTML=`\n      <div class="empty-wrap">\n        <div class="empty-icon"><i class="fas fa-triangle-exclamation"></i></div>\n        <h2>Eroare</h2>\n        <p>${escapeHtml(t)}</p>\n        <div style="display:flex;gap:10px;justify-content:center;">\n          <button class="primary-btn" type="button" id="backBtn"><i class="fas fa-arrow-left"></i> Înapoi</button>\n        </div>\n      </div>`;const i=document.getElementById("backBtn");i&&i.addEventListener("click",()=>history.back())}async function loadLocation(e){try{const t=await(window.SecureApiService?.get(`/locations/${e}`)||{}),n=t&&t.success?t.data:t;if(!n)throw new Error("Nu s-au putut încărca detaliile locației");i.location=n}catch(e){console.error("Load location error",e),i.location=null}}async function loadHours(e){try{const t=await(window.SecureApiService?.get(`/locations/${e}/hours`)||{}),n=t&&t.success?t.data:t,a=Array.isArray(n)?n.map(mapBackendHour).filter(Boolean):[],s=[0,1,2,3,4,5,6];i.hours=s.map(e=>a.find(t=>t.day===e)||{day:e,isOpen:!0,is24:!1,open:"09:00",close:"22:00"})}catch(e){console.warn("Hours load failed, using defaults",e),i.hours=Array.from({length:7},(e,t)=>({day:t,isOpen:!0,is24:!1,open:"09:00",close:"22:00"}))}}async function loadRecentReservations(e){try{let t=await(window.SecureApiService?.get(`/locations/${e}/reservations?limit=3`)||{}),n=t&&t.success?t.data:t;Array.isArray(n)||(t=await(window.SecureApiService?.get(`/reservations?locationId=${encodeURIComponent(e)}&limit=3`)||{}),n=t&&t.success?t.data:t),i.reservations=Array.isArray(n)?n:[]}catch(e){console.warn("Reservations load failed",e),i.reservations=[]}}async function onDelete(){if(window.confirm("Sigur ștergi această locație?"))try{await window.SecureApiService.delete(`/locations/${t}`),alert("Locația a fost ștearsă."),window.location.href="business-locations.html"}catch(e){console.error("Delete failed",e),alert("Ștergerea locației a eșuat.")}}function formatTime12(e){if(!e)return"";const[t,i]=String(e).split(":"),n=parseInt(t,10)||0;return`${n%12||12}:${i??"00"} ${n>=12?"PM":"AM"}`}function mapBackendHour(e){if(!e)return null;let t=0;if("number"==typeof e.DayOfWeek)t=e.DayOfWeek;else if("string"==typeof e.DayOfWeek){const i=parseInt(e.DayOfWeek,10);if(isNaN(i)){const i=["Duminică","Luni","Marți","Miercuri","Joi","Vineri","Sâmbătă"].findIndex(t=>t.toLowerCase()===e.DayOfWeek.toLowerCase());t=i>=0?i:0}else t=i}else"number"==typeof e.day&&(t=e.day);const i=!(!e.IsClosed&&!e.isClosed),n=e.OpenTime||e.open||"",a=e.CloseTime||e.close||"",s=!i&&(!0===e.Is24Hours||!0===e.is24||"00:00"===n&&("23:59"===a||"24:00"===a));return{day:t,isOpen:!i,is24:s,open:s?"00:00":n||"09:00",close:s?"23:59":a||"22:00"}}function escapeHtml(e){return String(e).replace(/[&<>"]/g,e=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;"}[e]))}!async function(){try{if(!window.SecureApiService||!window.SecureApiService.isAuthenticated())return void(window.location.href="business-auth.html");!function(){if(!e)return;e.innerHTML='\n      <div style="display:flex;align-items:center;justify-content:center;padding:40px 0;">\n        <div class="loading-spinner" style="width:28px;height:28px;border:3px solid #e5e7eb;border-top-color:#7c3aed;border-radius:50%;animation:spin 1s linear infinite;"></div>\n        <span style="margin-left:10px;color:#64748b;">Se încarcă detaliile locației...</span>\n      </div>'}(),await Promise.all([loadLocation(Number(t)),loadHours(Number(t)),loadRecentReservations(Number(t))]),function(){if(!e||!i.location)return void showError("Detaliile locației nu sunt disponibile.");const n=i.location,a=n.id||n.Id||n.ID||Number(t),s=n.name||n.Name||"Locație",o=n.address||n.Address||n.location||"Adresă necunoscută",r=n.tags||n.Tags||[],c=Array.isArray(r)?r:"string"==typeof r?r.split(","):[],l=n.photoUrl||n.photo||n.imageUrl||n.ImageUrl||"https://picsum.photos/seed/lprof"+t+"/1200/800",d=function(e){try{const t=(new Date).getDay(),i=e.find(e=>e.day===t);return i&&i.isOpen?`${formatTime12(i.open)} - ${formatTime12(i.close)}`:"Închis azi"}catch{return"Închis azi"}}(i.hours);e.innerHTML=`\n      <div class="hero-card">\n        <div class="hero-media"><img src="${escapeHtml(l)}" alt="${escapeHtml(s)}" loading="lazy"/></div>\n        <h1 class="loc-title">${escapeHtml(s)}</h1>\n        <div class="address-line"><i class="fas fa-location-dot" style="color:#7c3aed;"></i><span>${escapeHtml(o)}</span></div>\n        <div class="tag-badges">${c.map(e=>`<span class='tag'>${escapeHtml(String(e).trim())}</span>`).join("")}</div>\n        <div class="today-hours"><i class="fas fa-clock"></i> ${d}</div>\n      </div>\n      <div class="actions-row">\n        <button class="action-btn" id="hoursBtn"><i class="fas fa-clock"></i> Program</button>\n        <button class="action-btn green" id="reservationsBtn"><i class="fas fa-calendar"></i> Rezervări</button>\n      </div>\n      <div class="stats-grid">\n        <div class="stat-card"><div class="number">${i.reservations.length}</div><div style="color:#9ca3af;font-size:.65rem;letter-spacing:.5px;font-weight:600;">REZERVĂRI</div></div>\n        <div class="stat-card p2"><div class="number">${i.hours.filter(e=>e.isOpen).length}</div><div style="color:#9ca3af;font-size:.65rem;letter-spacing:.5px;font-weight:600;">ZILE DESCHIS</div></div>\n      </div>\n      ${i.reservations.length?`<div class="reservations-list"><h3 class="section-title">Rezervări Recente</h3>${i.reservations.slice(0,3).map(e=>function(e){const t=(e.status||e.Status||"").toString().toLowerCase(),i=e.customerName||e.CustomerName||e.name||"Client",n=e.reservationDate||e.date||e.Date||e.createdAt||"",a=e.timeSlot||e.time||e.Time||"",s=e.numberOfPeople||e.people||e.People||e.partySize||"",o="confirmed"===t?"status-confirmed":"pending"===t?"status-pending":"canceled"===t||"cancelled"===t?"status-cancelled":"",r=n?new Date(n).toLocaleDateString("ro-RO"):"";return`<div class="reservation-item">\n      <div class="reservation-item-header"><div style='font-weight:600;'>${escapeHtml(i)}</div><span class="status-chip ${o}">${escapeHtml(t.toUpperCase()||"—")}</span></div>\n      <div style='font-size:.65rem;color:#9ca3af;'>${escapeHtml(r)} ${a?"la "+escapeHtml(a):""}</div>\n      <div style='font-size:.65rem;color:#9ca3af;'>${escapeHtml(String(s))} persoane</div>\n    </div>`}(e)).join("")}<button class="action-btn" style="flex:1 1 100%;margin-top:4px;" id="allReservations"><i class='fas fa-list'></i> Toate Rezervările</button></div>`:""}\n      <div class="hours-table"><h3 class="section-title">Program Săptămânal</h3>${i.hours.map(e=>function(e){const t=["Duminică","Luni","Marți","Miercuri","Joi","Vineri","Sâmbătă"],i=e.isOpen?`${formatTime12(e.open)} - ${formatTime12(e.close)}`:"Închis";return`<div class="hours-row"><div class="hours-day">${t[e.day]}</div><div class="hours-range ${e.isOpen?"hours-open":"hours-closed"}">${i}</div></div>`}(e)).join("")}</div>\n      <div class="danger-bar"><div><strong style="color:#ef4444;">Atenție!</strong><div style="font-size:.7rem;color:#b8b8b8;margin-top:4px;">Ștergerea locației este permanentă și nu poate fi anulată.</div></div><button id="deleteBtn"><i class="fas fa-trash"></i> Șterge Locația</button></div>\n    `,document.getElementById("hoursBtn")?.addEventListener("click",()=>window.location.href="business-location-hours.html?id="+a),document.getElementById("reservationsBtn")?.addEventListener("click",()=>window.location.href="business-reservations.html?id="+a),document.getElementById("allReservations")?.addEventListener("click",()=>window.location.href="business-reservations.html?id="+a),document.getElementById("deleteBtn")?.addEventListener("click",onDelete)}()}catch(e){console.error("Location init error:",e),showError("A apărut o eroare la încărcarea locației.")}finally{i.loading=!1}}()});