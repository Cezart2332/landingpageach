document.addEventListener("DOMContentLoaded",()=>{const e=document.getElementById("daysWrap"),a=document.getElementById("saveHoursBtn"),t=new URLSearchParams(location.search).get("id"),n=document.getElementById("locNameSub"),s=document.getElementById("quickActions"),l=t?`Locație #${t}`:"Locație";n&&(n.textContent=l);const i=[{value:0,label:"Duminică"},{value:1,label:"Luni"},{value:2,label:"Marți"},{value:3,label:"Miercuri"},{value:4,label:"Joi"},{value:5,label:"Vineri"},{value:6,label:"Sâmbătă"}];let o=i.map(e=>({day:e.value,isOpen:!0,is24:!1,open:"09:00",close:"22:00"})),r=!1;function markDirty(){r=!0,a&&(a.disabled=!1)}function formatDisp(e){const[a,t]=e.split(":"),n=parseInt(a||"0",10);return`${n%12||12}:${t??"00"} ${n>=12?"PM":"AM"}`}function dayCard(e){const a=i.find(a=>a.value===e.day)?.label??"";return`<div class="day-card" data-day="${e.day}">\n      <div class="day-head">\n        <h4>${a}</h4>\n        <label class="switch"><input type="checkbox" data-open-toggle ${e.isOpen?"checked":""}><span class="slider"></span></label>\n      </div>\n      <div class="day-body">${e.isOpen?function(e){return`<div class="block">\n        <label>24H NON‑STOP</label>\n        <button type="button" class="toggle-24 ${e.is24?"active":""}" data-24>${e.is24?'<i class="fas fa-check"></i> Activ':"Activează"}</button>\n      </div>\n      ${e.is24?"":`<div class="block">\n        <label>DESCHIDE</label>\n        <button type="button" class="time-btn" data-time="open"> <i class="fas fa-clock"></i> ${formatDisp(e.open)}</button>\n      </div>\n      <div class="block">\n        <label>ÎNCHIDE</label>\n        <button type="button" class="time-btn" data-time="close"> <i class="fas fa-clock"></i> ${formatDisp(e.close)}</button>\n      </div>`}`}(e):"<div class='closed-label'>ÎNCHIS</div>"}</div>\n    </div>`}function render(){e&&(e.innerHTML=o.map(e=>dayCard(e)).join(""),function(){if(!e)return;e.querySelectorAll("[data-open-toggle]").forEach(e=>{e.addEventListener("change",a=>{const t=(a.target instanceof HTMLElement?a.target:e).closest(".day-card"),n=Number(t?.getAttribute("data-day")),s=o.find(e=>e.day===n);s&&(s.isOpen=a.target instanceof HTMLInputElement?!!a.target.checked:!s.isOpen,s.isOpen||(s.is24=!1),markDirty(),render())})}),e.querySelectorAll("[data-24]").forEach(e=>{e.addEventListener("click",a=>{const t=(a.target instanceof HTMLElement?a.target:e).closest(".day-card"),n=Number(t?.getAttribute("data-day")),s=o.find(e=>e.day===n);s&&(s.is24=!s.is24,s.is24&&(s.open="00:00",s.close="23:59"),markDirty(),render())})}),e.querySelectorAll("[data-time]").forEach(e=>{e.addEventListener("click",()=>{const a=e.closest(".day-card"),t=Number(a?.getAttribute("data-day")),n=e.getAttribute("data-time");n&&function(e,a){if(!(c&&d&&u&&p))return;y.day=e,y.field=a,y.value=null,function(){if(!d)return;d.innerHTML="";const e=new Date;e.setHours(0,0,0,0);for(let a=0;a<48;a++){const t=new Date(e.getTime()+30*a*6e4),n=`${t.getHours().toString().padStart(2,"0")}:${t.getMinutes().toString().padStart(2,"0")}`,s=document.createElement("div");s.className="tm-item",s.innerHTML=`<span>${formatDisp(n)}</span><i class="fas fa-clock" style="opacity:.4;"></i>`,s.dataset.val=n,s.addEventListener("click",()=>{y.value=n,d.querySelectorAll(".tm-item").forEach(e=>e.classList.toggle("active",e.getAttribute("data-val")===n)),s.classList.add("active")}),d.appendChild(s)}}(),p.textContent="Selectează ora de "+("open"===a?"deschidere":"închidere"),c.style.display="flex"}(t,n)})})}())}s&&s.querySelectorAll("[data-action]").forEach(e=>{e.addEventListener("click",()=>{const a=e.getAttribute("data-action");"nonstop"===a?o=o.map(e=>({...e,isOpen:!0,is24:!0,open:"00:00",close:"23:59"})):"openall"===a?o=o.map(e=>({...e,isOpen:!0,is24:!1,open:"09:00",close:"22:00"})):"closeall"===a?o=o.map(e=>({...e,isOpen:!1,is24:!1})):"weekdays"===a?o=o.map(e=>({...e,isOpen:e.day>=1&&e.day<=5,is24:!1,open:"09:00",close:"18:00"})):"weekend"===a&&(o=o.map(e=>({...e,isOpen:0===e.day||6===e.day,is24:!1,open:"10:00",close:"23:00"}))),markDirty(),render()})});const c=document.getElementById("timeModal"),d=document.getElementById("tmList"),u=document.getElementById("tmConfirm"),p=document.getElementById("tmTitle"),y={day:null,field:null,value:null};function mapBackendHour(e){if(!e)return null;let a=0;if("number"==typeof e.DayOfWeek)a=e.DayOfWeek;else if("string"==typeof e.DayOfWeek){const t=parseInt(e.DayOfWeek,10);if(isNaN(t)){const t=i.find(a=>a.label.toLowerCase()===e.DayOfWeek.toLowerCase());a=t?t.value:0}else a=t}else"number"==typeof e.day&&(a=e.day);const t=!(!e.IsClosed&&!e.isClosed),n=e.OpenTime||e.open||"",s=e.CloseTime||e.close||"",l=!t&&(!0===e.Is24Hours||!0===e.is24||"00:00"===n&&("23:59"===s||"24:00"===s));return{day:a,isOpen:!t,is24:l,open:l?"00:00":n||"09:00",close:l?"23:59":s||"22:00"}}u&&c&&(u.addEventListener("click",()=>{if(!y.value)return void alert("Selectează o oră.");const e=o.find(e=>e.day===y.day);e?("open"===y.field?e.open=y.value:e.close=y.value,markDirty(),c.style.display="none",render()):c.style.display="none"}),c.querySelectorAll("[data-close]").forEach(e=>e.addEventListener("click",()=>{c.style.display="none"}))),a&&a.addEventListener("click",async()=>{if(a.disabled)return;const e=a.querySelector("span");a.disabled=!0,e&&(e.textContent="Se salvează...");try{const n=new FormData;i.forEach((e,a)=>{const t=o.find(a=>a.day===e.value)||{isOpen:!0,is24:!1,open:"09:00",close:"22:00"},s=!t.isOpen,l=!!t.is24;if(n.append(`day_${a}_closed`,String(s)),!s){const e=l?"00:00":t.open,s=l?"23:59":t.close;n.append(`day_${a}_open`,e),n.append(`day_${a}_close`,s)}});const{success:s,error:l}=await(window.SecureApiService?.post(`/locations/${t}/hours`,n)||{});s?(r=!1,a.innerHTML='<i class="fas fa-check"></i> <span>Program Salvat</span>',setTimeout(()=>{a.innerHTML='<i class="fas fa-save"></i> <span>Salvează Program</span>',a.disabled=!0},1400)):(console.error("Save hours error:",l),alert("Eroare: salvarea programului a eșuat"),a.disabled=!1,e&&(e.textContent="Salvează Program"))}catch(e){console.error("Error saving hours:",e),alert("Eroare: salvarea programului a eșuat"),a.disabled=!1;const t=a.querySelector("span");t&&(t.textContent="Salvează Program")}}),async function(){try{e&&(e.innerHTML='<div style="display:flex;justify-content:center;padding:28px 0;color:#64748b;">\n          <i class="fas fa-spinner fa-spin" style="margin-right:8px;"></i>Se încarcă programul...\n        </div>');const a=await(window.SecureApiService?.get(`/locations/${t}/hours`)||{}),n=(a&&a.success&&Array.isArray(a.data)?a.data:[]).map(mapBackendHour).filter(Boolean);o=i.map(e=>n.find(a=>a.day===e.value)||{day:e.value,isOpen:!0,is24:!1,open:"09:00",close:"22:00"})}catch(e){console.warn("Failed to load hours, using defaults",e),o=i.map(e=>({day:e.value,isOpen:!0,is24:!1,open:"09:00",close:"22:00"}))}finally{r=!1,a&&(a.disabled=!0),render()}}()});