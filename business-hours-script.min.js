document.addEventListener("DOMContentLoaded",()=>{const e=(()=>{try{const e=localStorage.getItem("ac_debug");return null===e||("1"===e||"true"===e||"on"===e)}catch{return!0}})(),dbg=(...a)=>{e&&console.debug("[HoursEditor]",...a)},a=document.getElementById("daysWrap"),t=document.getElementById("saveHoursBtn"),n=new URLSearchParams(location.search).get("id"),s=document.getElementById("locNameSub"),r=document.getElementById("quickActions"),o=n?`Locație #${n}`:"Locație";dbg("init",{locationId:n,href:location.href}),s&&(s.textContent=o);const i=[{value:0,label:"Duminică"},{value:1,label:"Luni"},{value:2,label:"Marți"},{value:3,label:"Miercuri"},{value:4,label:"Joi"},{value:5,label:"Vineri"},{value:6,label:"Sâmbătă"}];let l=i.map(e=>({day:e.value,isOpen:!0,is24:!1,open:"09:00",close:"22:00"})),c=!1;function markDirty(){c=!0,t&&(t.disabled=!1),dbg("markDirty",{dirty:c})}function formatDisp(e){const[a,t]=e.split(":"),n=parseInt(a||"0",10);return`${n%12||12}:${t??"00"} ${n>=12?"PM":"AM"}`}function dayCard(e){const a=i.find(a=>a.value===e.day)?.label??"";return`<div class="day-card" data-day="${e.day}">\n      <div class="day-head">\n        <h4>${a}</h4>\n        <label class="switch"><input type="checkbox" data-open-toggle ${e.isOpen?"checked":""}><span class="slider"></span></label>\n      </div>\n      <div class="day-body">${e.isOpen?function(e){return`<div class="block">\n        <label>24H NON‑STOP</label>\n        <button type="button" class="toggle-24 ${e.is24?"active":""}" data-24>${e.is24?'<i class="fas fa-check"></i> Activ':"Activează"}</button>\n      </div>\n      ${e.is24?"":`<div class="block">\n        <label>DESCHIDE</label>\n        <button type="button" class="time-btn" data-time="open"> <i class="fas fa-clock"></i> ${formatDisp(e.open)}</button>\n      </div>\n      <div class="block">\n        <label>ÎNCHIDE</label>\n        <button type="button" class="time-btn" data-time="close"> <i class="fas fa-clock"></i> ${formatDisp(e.close)}</button>\n      </div>`}`}(e):"<div class='closed-label'>ÎNCHIS</div>"}</div>\n    </div>`}function render(){a&&(dbg("render",{hours:l}),a.innerHTML=l.map(e=>dayCard(e)).join(""),function(){if(!a)return;a.querySelectorAll("[data-open-toggle]").forEach(e=>{e.addEventListener("change",a=>{const t=(a.target instanceof HTMLElement?a.target:e).closest(".day-card"),n=Number(t?.getAttribute("data-day")),s=l.find(e=>e.day===n);s&&(s.isOpen=a.target instanceof HTMLInputElement?!!a.target.checked:!s.isOpen,dbg("toggleOpen",{day:n,isOpen:s.isOpen}),s.isOpen||(s.is24=!1),markDirty(),render())})}),a.querySelectorAll("[data-24]").forEach(e=>{e.addEventListener("click",a=>{const t=(a.target instanceof HTMLElement?a.target:e).closest(".day-card"),n=Number(t?.getAttribute("data-day")),s=l.find(e=>e.day===n);s&&(s.is24=!s.is24,dbg("toggle24",{day:n,is24:s.is24}),s.is24&&(s.open="00:00",s.close="23:59"),markDirty(),render())})}),a.querySelectorAll("[data-time]").forEach(e=>{e.addEventListener("click",()=>{const a=e.closest(".day-card"),t=Number(a?.getAttribute("data-day")),n=e.getAttribute("data-time");n&&(dbg("openTimePicker",{day:t,field:n}),function(e,a){if(!(d&&u&&p&&y))return;m.day=e,m.field=a,m.value=null,function(){if(!u)return;u.innerHTML="";const e=new Date;e.setHours(0,0,0,0);for(let a=0;a<48;a++){const t=new Date(e.getTime()+30*a*6e4),n=`${t.getHours().toString().padStart(2,"0")}:${t.getMinutes().toString().padStart(2,"0")}`,s=document.createElement("div");s.className="tm-item",s.innerHTML=`<span>${formatDisp(n)}</span><i class="fas fa-clock" style="opacity:.4;"></i>`,s.dataset.val=n,s.addEventListener("click",()=>{m.value=n,u.querySelectorAll(".tm-item").forEach(e=>e.classList.toggle("active",e.getAttribute("data-val")===n)),s.classList.add("active"),dbg("timePicker:select",{val:n})}),u.appendChild(s)}}(),y.textContent="Selectează ora de "+("open"===a?"deschidere":"închidere"),dbg("timePicker:open",{day:e,field:a}),d.style.display="flex"}(t,n))})})}())}r&&r.querySelectorAll("[data-action]").forEach(e=>{e.addEventListener("click",()=>{const a=e.getAttribute("data-action");"nonstop"===a?l=l.map(e=>({...e,isOpen:!0,is24:!0,open:"00:00",close:"23:59"})):"openall"===a?l=l.map(e=>({...e,isOpen:!0,is24:!1,open:"09:00",close:"22:00"})):"closeall"===a?l=l.map(e=>({...e,isOpen:!1,is24:!1})):"weekdays"===a?l=l.map(e=>({...e,isOpen:e.day>=1&&e.day<=5,is24:!1,open:"09:00",close:"18:00"})):"weekend"===a&&(l=l.map(e=>({...e,isOpen:0===e.day||6===e.day,is24:!1,open:"10:00",close:"23:00"}))),dbg("quickAction",{action:a,hours:l}),markDirty(),render()})});const d=document.getElementById("timeModal"),u=document.getElementById("tmList"),p=document.getElementById("tmConfirm"),y=document.getElementById("tmTitle"),m={day:null,field:null,value:null};function mapBackendHour(e){if(!e)return null;let a=0;if("number"==typeof e.DayOfWeek)a=e.DayOfWeek;else if("string"==typeof e.DayOfWeek){const t=parseInt(e.DayOfWeek,10);if(isNaN(t)){const t=i.find(a=>a.label.toLowerCase()===e.DayOfWeek.toLowerCase());a=t?t.value:0}else a=t}else"number"==typeof e.day&&(a=e.day);a>=1&&a<=7&&(a%=7),(a<0||a>6)&&(a=0);const t=!(!e.IsClosed&&!e.isClosed),n=e.OpenTime||e.open||"",s=e.CloseTime||e.close||"",r=!t&&(!0===e.Is24Hours||!0===e.is24||"00:00"===n&&("23:59"===s||"24:00"===s)),o={day:a,isOpen:!t,is24:r,open:r?"00:00":n||"09:00",close:r?"23:59":s||"22:00"};return dbg("mapBackendHour",{original:e,normalized:o}),o}p&&d&&(p.addEventListener("click",()=>{if(!m.value)return void alert("Selectează o oră.");const e=l.find(e=>e.day===m.day);e?("open"===m.field?e.open=m.value:e.close=m.value,dbg("timePicker:confirm",{day:m.day,field:m.field,value:m.value}),markDirty(),d.style.display="none",render()):d.style.display="none"}),d.querySelectorAll("[data-close]").forEach(e=>e.addEventListener("click",()=>{d.style.display="none"}))),t&&t.addEventListener("click",async()=>{if(t.disabled)return;const e=t.querySelector("span");t.disabled=!0,e&&(e.textContent="Se salvează...");try{const a=new FormData;i.forEach((e,t)=>{const n=l.find(a=>a.day===e.value)||{isOpen:!0,is24:!1,open:"09:00",close:"22:00"},s=!n.isOpen,r=!!n.is24;if(a.append(`day_${t}_closed`,String(s)),!s){const e=r?"00:00":n.open,s=r?"23:59":n.close;a.append(`day_${t}_open`,e),a.append(`day_${t}_close`,s)}});const s=function(e){const a={};for(const[t,n]of e.entries())a[t]=n;return a}(a);dbg("save:POST",{url:`/locations/${n}/hours`,payload:s});let r=await(window.SecureApiService?.post(`/locations/${n}/hours`,a)||{});dbg("save:respPOST",r);let{success:o,error:d,data:u}=r;if(o||(dbg("save:POST failed, trying PUT"),r=await(window.SecureApiService?.put(`/locations/${n}/hours`,a)||{}),dbg("save:respPUT",r),o=r?.success,d=r?.error,u=r?.data),o){try{const e=Array.isArray(u)?u:u&&Array.isArray(u.items)?u.items:[];if(dbg("save:respDataExtracted",{count:Array.isArray(e)?e.length:0}),e&&e.length){const a=e.map(mapBackendHour).filter(Boolean);dbg("save:respMapped",a);l=[0,1,2,3,4,5,6].map(e=>a.find(a=>a.day===e)||l.find(a=>a.day===e)||{day:e,isOpen:!0,is24:!1,open:"09:00",close:"22:00"})}}catch(e){dbg("save:mapResponseError",e)}try{dbg("save:refetch:GET",{url:`/locations/${n}/hours`});const e=await(window.SecureApiService?.get(`/locations/${n}/hours`)||{});dbg("save:refetch:resp",e);const a=e&&e.success&&Array.isArray(e.data)?e.data:[];if(a.length){const e=a.map(mapBackendHour).filter(Boolean);l=i.map(a=>e.find(e=>e.day===a.value)||{day:a.value,isOpen:!0,is24:!1,open:"09:00",close:"22:00"}),dbg("save:refetch:mapped",l)}}catch(e){dbg("save:refetch:error",e)}c=!1,t.innerHTML='<i class="fas fa-check"></i> <span>Program Salvat</span>',setTimeout(()=>{t.innerHTML='<i class="fas fa-save"></i> <span>Salvează Program</span>',t.disabled=!0},1400)}else console.error("Save hours error:",d),dbg("save:error",d),alert("Eroare: salvarea programului a eșuat"),t.disabled=!1,e&&(e.textContent="Salvează Program")}catch(e){console.error("Error saving hours:",e),dbg("save:exception",e),alert("Eroare: salvarea programului a eșuat"),t.disabled=!1;const a=t.querySelector("span");a&&(a.textContent="Salvează Program")}}),async function(){try{a&&(a.innerHTML='<div style="display:flex;justify-content:center;padding:28px 0;color:#64748b;">\n          <i class="fas fa-spinner fa-spin" style="margin-right:8px;"></i>Se încarcă programul...\n        </div>'),dbg("load:GET",{url:`/locations/${n}/hours`});const e=await(window.SecureApiService?.get(`/locations/${n}/hours`)||{});dbg("load:resp",e);const t=e&&e.success&&Array.isArray(e.data)?e.data:[];dbg("load:extracted",t);const s=t.map(mapBackendHour).filter(Boolean);dbg("load:mapped",s),l=i.map(e=>s.find(a=>a.day===e.value)||{day:e.value,isOpen:!0,is24:!1,open:"09:00",close:"22:00"})}catch(e){console.warn("Failed to load hours, using defaults",e),dbg("load:errorDefaults",e),l=i.map(e=>({day:e.value,isOpen:!0,is24:!1,open:"09:00",close:"22:00"}))}finally{c=!1,t&&(t.disabled=!0),render()}}(),window.hoursDebug={get hours(){return l},render:render,markDirty:markDirty,async refetch(){try{dbg("debug:refetch");const e=await(window.SecureApiService?.get(`/locations/${n}/hours`)||{}),a=(e&&e.success&&Array.isArray(e.data)?e.data:[]).map(mapBackendHour).filter(Boolean);l=i.map(e=>a.find(a=>a.day===e.value)||{day:e.value,isOpen:!0,is24:!1,open:"09:00",close:"22:00"}),render()}catch(e){console.error("debug:refetch error",e)}}}});