document.addEventListener("DOMContentLoaded",()=>{const e=new URLSearchParams(location.search).get("id")||"1",t=document.getElementById("editLocationForm"),n=document.getElementById("name"),a=document.getElementById("address"),o=document.getElementById("lat"),i=document.getElementById("lng"),l=document.getElementById("description"),s=document.getElementById("tags"),d=document.getElementById("tagsPreview"),r=document.getElementById("photoArea"),c=document.getElementById("menuBtn"),u=document.getElementById("menuStatus"),m=document.getElementById("geoBtn"),p=document.getElementById("gpsBtn"),g=document.getElementById("geoStatus"),v=document.getElementById("reservationsToggle"),f=document.getElementById("saveBtn");let h=[],E=null,y=null,L={loading:!1};const b={1:{name:"Central Bistro",address:"Str. Libertății 10, Cluj",lat:"46.7712",lng:"23.6236",tags:["bistro","terasa","wifi"],description:"Locație centrală cu atmosferă relaxantă.",photo:`https://picsum.photos/seed/edit${e}/900/600`,hasMenu:!0,reservationsEnabled:!0},2:{name:"Urban Roast",address:"Bd. Eroilor 25, Cluj",lat:"46.7700",lng:"23.5900",tags:["cafea","specialty"],description:"Cafea de origine și prăjituri artizanale.",photo:`https://picsum.photos/seed/edit${e}/900/600`,hasMenu:!1,reservationsEnabled:!0},3:{name:"Garden Lounge",address:"Str. Memorandumului 3",lat:"46.7720",lng:"23.6200",tags:["lounge","cocktail","live"],description:"Cocktail bar cu live sessions.",photo:`https://picsum.photos/seed/edit${e}/900/600`,hasMenu:!0,reservationsEnabled:!1}},B=b[e]||b[1];function renderPhoto(e){r.innerHTML=`<img src="${e}" class="photo-preview" alt="loc" loading="lazy"/><button type="button" class="remove-photo" id="removePhoto"><i class='fas fa-times'></i> Elimină</button>`,document.getElementById("removePhoto").addEventListener("click",()=>{E=null,r.innerHTML='<i class="fas fa-camera" style="font-size:2rem;color:#a855f7;"></i><p style="margin:10px 0 4px;font-weight:600;color:#a855f7;">Adaugă / Înlocuiește foto</p><p style="margin:0;color:#64748b;font-size:.7rem;">Click pentru selectare (16:9)</p>'})}function renderTags(){d.innerHTML=h.map(e=>`<span class="tag-chip">${e}<button type="button" data-del="${e}">×</button></span>`).join(""),d.querySelectorAll("[data-del]").forEach(e=>e.addEventListener("click",()=>{h=h.filter(t=>t!==e.dataset.del),renderTags()}))}r.addEventListener("click",()=>function(){const e=document.createElement("input");e.type="file",e.accept="image/*",e.onchange=()=>{const t=e.files&&e.files[0];if(!t)return;E=t;renderPhoto(URL.createObjectURL(t))},e.click()}()),c.addEventListener("click",()=>{const e=document.createElement("input");e.type="file",e.accept="application/pdf",e.onchange=()=>{const t=e.files&&e.files[0];t&&(y=t,u.innerHTML=`<span style='color:#22c55e;font-weight:600;'>${t.name} ✓</span>`)},e.click()}),s.addEventListener("input",()=>{const e=s.value;e.includes(",")&&(e.split(",").map(e=>e.trim()).filter(Boolean).forEach(e=>{!h.includes(e)&&h.length<20&&h.push(e)}),s.value="",renderTags())}),s.addEventListener("keydown",e=>{if("Enter"===e.key){e.preventDefault();const t=s.value.trim();t&&(h.includes(t)||h.push(t),s.value="",renderTags())}"Backspace"!==e.key||s.value||(h.pop(),renderTags())});function updateGeoStatus(){L.loading?g.innerHTML="<span style='color:#f59e0b;'>Obțin coordonate...</span>":o.value&&i.value?g.innerHTML=`<span style='color:#22c55e;'>Coord: ${o.value}, ${i.value}</span>`:g.innerHTML=""}function validate(){let e=!0;return n.value.trim()||(e=!1),a.value.trim()||(e=!1),o.value&&i.value||(e=!1),f.disabled=!e,e}m.addEventListener("click",()=>{const e=a.value.trim();e?(L.loading=!0,updateGeoStatus(),fetch(`https://api.geoapify.com/v1/geocode/search?text=${encodeURIComponent(e+", Romania")}&limit=1&lang=ro&filter=countrycode:ro&apiKey=d5466dbfa4a84344b872af4009106e17`).then(e=>e.json()).then(e=>{const t=e.features&&e.features[0];if(t){const[e,n]=t.geometry.coordinates;o.value=n.toFixed(6),i.value=e.toFixed(6)}else alert("Adresă negăsită")}).catch(()=>alert("Eroare geocodare")).finally(()=>{L.loading=!1,updateGeoStatus()})):alert("Introdu adresa.")}),p.addEventListener("click",()=>{alert("Demo GPS – valori setate."),o.value="44.426800",i.value="26.102500",updateGeoStatus()}),["input","blur"].forEach(e=>n.addEventListener(e,validate)),a.addEventListener("input",validate),o.addEventListener("input",validate),i.addEventListener("input",validate),t.addEventListener("submit",t=>{t.preventDefault(),validate()&&(f.disabled=!0,f.innerHTML='<i class="fas fa-spinner fa-spin"></i> Salvare...',setTimeout(()=>{alert("Locație actualizată (demo)."),window.location.href="business-location.html?id="+e},1e3))}),n.value=B.name,a.value=B.address,o.value=B.lat,i.value=B.lng,l.value=B.description,v.checked=!!B.reservationsEnabled,h=[...B.tags],renderTags(),renderPhoto(B.photo),B.hasMenu&&(u.innerHTML='<span style="color:#22c55e;font-weight:600;">Meniu existent ✅</span>'),validate()});