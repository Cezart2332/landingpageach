function escapeHtml(e){return String(e).replace(/[&<>"']/g,e=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;"}[e]))}document.addEventListener("DOMContentLoaded",()=>{const e=new URLSearchParams(location.search).get("id");if(!e)return alert("ID locație lipsă."),void(window.location.href="business-locations.html");const t=document.getElementById("locName"),a=document.getElementById("statsRow"),n=document.getElementById("filterTabs"),s=document.getElementById("reservationsList"),i=document.getElementById("cancelModal"),c=document.getElementById("cancelReason"),l=document.getElementById("confirmCancelBtn"),r=document.getElementById("locProfileBtn");r?.addEventListener("click",()=>window.location.href="business-location.html?id="+e);const o={locationName:"Locație",reservations:[],filter:"all",cancelTarget:null,loading:!0};async function loadLocationName(){try{const a=await(window.SecureApiService?.get(`/locations/${e}`)||{}),n=a&&a.success?a.data:a;n&&n.name&&(o.locationName=n.name),t&&(t.textContent=o.locationName)}catch{}}async function loadReservations(){try{let t=await(window.SecureApiService?.get(`/locations/${e}/reservations`)||{}),a=t&&t.success?t.data:t;Array.isArray(a)||(t=await(window.SecureApiService?.get(`/reservations?locationId=${encodeURIComponent(e)}`)||{}),a=t&&t.success?t.data:t),o.reservations=Array.isArray(a)?a:[]}catch(e){console.error("Load reservations error:",e),o.reservations=[]}}function stats(){return{total:o.reservations.length,pending:o.reservations.filter(e=>"pending"===statusOf(e)).length,confirmed:o.reservations.filter(e=>"confirmed"===statusOf(e)).length,completed:o.reservations.filter(e=>"completed"===statusOf(e)).length,canceled:o.reservations.filter(e=>statusOf(e).startsWith("canceled")).length}}function statusOf(e){return(e.status||e.Status||"").toString().toLowerCase()}function renderList(){const e=function(){const e=[...o.reservations].sort((e,t)=>{const a={pending:0,confirmed:1,completed:2,canceled:3,cancelled:3},n=statusOf(e),s=statusOf(t);if(a[n]!==a[s])return(a[n]??99)-(a[s]??99);const i=new Date(e.createdAt||e.date||0).getTime();return new Date(t.createdAt||t.date||0).getTime()-i});return"all"===o.filter?e:"canceled"===o.filter?e.filter(e=>statusOf(e).startsWith("canceled")):e.filter(e=>statusOf(e)===o.filter)}();if(!e.length)return s.innerHTML="<div class='empty-state'><div class='empty-icon'><i class=\"fas fa-calendar-xmark\"></i></div><h3 style='margin:0 0 8px;font-size:1.4rem;'>Nicio rezervare</h3><p style='margin:0 0 14px;color:#94a3b8;font-size:.85rem;'>Rezervările vor apărea aici pe măsură ce sunt create.</p><button class='reload-btn' id='reloadBtn'><i class=\"fas fa-rotate\"></i> Reîncarcă</button></div>",void document.getElementById("reloadBtn")?.addEventListener("click",async()=>{await loadReservations(),render()});s.innerHTML=e.map(e=>function(e){const t=statusOf(e),a=e.reservationDate||e.date||e.Date||"",n=e.timeSlot||e.time||e.Time||"",s=e.numberOfPeople||e.people||e.People||e.partySize||"",i=e.phone||e.Phone||e.customerPhone||"",c=e.customerName||e.CustomerName||e.name||"Client",l=e.specialRequests||e.notes||"",r=e.createdAt?new Date(e.createdAt).getTime():Date.now();return`<div class="reservation-card" data-id="${e.id||e.Id}">\n      <div class="res-head">\n        <h3 class="res-name">${escapeHtml(c)}</h3>\n        <span class="${function(e){return"chip "+e}(t)}">${escapeHtml(t.toUpperCase()||"—")}</span>\n      </div>\n      <div class="res-grid">\n        <div class="res-meta"><h6>DATA</h6><span>${escapeHtml(a?new Date(a).toLocaleDateString("ro-RO"):"")}</span></div>\n        <div class="res-meta"><h6>ORA</h6><span>${escapeHtml(n)}</span></div>\n        <div class="res-meta"><h6>PERS</h6><span>${escapeHtml(String(s))}</span></div>\n        <div class="res-meta"><h6>ID</h6><span>#${escapeHtml(String(e.id||e.Id||r))}</span></div>\n        <div class="res-meta"><h6>TELEFON</h6><span>${escapeHtml(i||"—")}</span></div>\n      </div>\n      ${l?`<div class="special-req"><i class="fas fa-comment-dots" style="opacity:.6;"></i> ${escapeHtml(l)}</div>`:""}\n      <div class="actions-row">\n        ${function(e,t){const a=t.id||t.Id;return"pending"===e?`<button class="act-btn green" data-act="confirm" data-id="${a}"><i class='fas fa-check'></i> Confirmă</button><button class="act-btn red" data-act="cancel" data-id="${a}"><i class='fas fa-xmark'></i> Respinge</button>`:"confirmed"===e?`<button class="act-btn blue" data-act="complete" data-id="${a}"><i class='fas fa-flag-checkered'></i> Finalizează</button><button class="act-btn red" data-act="cancel" data-id="${a}"><i class='fas fa-ban'></i> Anulează</button>`:'<button class="act-btn" disabled style="opacity:.4;cursor:not-allowed;"><i class=\'fas fa-info-circle\'></i> Fără acțiuni</button>'}(t,e)}\n      </div>\n    </div>`}(e)).join(""),s.querySelectorAll("[data-act]")?.forEach(e=>e.addEventListener("click",handleAction))}async function handleAction(e){const t=e.currentTarget,a=t.dataset.act,n=t.dataset.id;"confirm"===a?await updateStatus(n,"confirmed"):"complete"===a?await updateStatus(n,"completed"):"cancel"===a&&(o.cancelTarget=n,i&&(c.value="",i.style.display="flex"))}async function updateStatus(t,a,n){try{let s=await window.SecureApiService.post(`/locations/${e}/reservations/${t}/status`,{status:a,reason:n});if(s&&s.success||(s=await window.SecureApiService.post(`/reservations/${t}/status`,{status:a,reason:n,locationId:e})),s&&s.success)return await loadReservations(),void render();alert("Actualizarea statusului a eșuat")}catch(e){console.error("Status update failed",e),alert("Actualizarea statusului a eșuat")}}function closeCancel(){i&&(i.style.display="none")}function render(){!function(){const e=stats();a.innerHTML=`\n      <div class="stat-box"><div class="stat-label">TOTAL</div><div class="stat-value">${e.total}</div></div>\n      <div class="stat-box amber"><div class="stat-label">ÎN AȘTEPTARE</div><div class="stat-value">${e.pending}</div></div>\n      <div class="stat-box green"><div class="stat-label">CONFIRMATE</div><div class="stat-value">${e.confirmed}</div></div>\n      <div class="stat-box"><div class="stat-label">FINALIZATE</div><div class="stat-value">${e.completed}</div></div>\n      <div class="stat-box"><div class="stat-label" style="color:#ef4444;">ANULATE</div><div class="stat-value" style="color:#ef4444;">${e.canceled}</div></div>`}(),function(){const e=stats(),t=[{id:"all",label:"Toate",count:e.total},{id:"pending",label:"În așteptare",count:e.pending},{id:"confirmed",label:"Confirmate",count:e.confirmed},{id:"completed",label:"Finalizate",count:e.completed},{id:"canceled",label:"Anulate",count:e.canceled}];n.innerHTML=t.map(e=>`<button type="button" class="filter-btn ${o.filter===e.id?"active":""}" data-filter="${e.id}">${e.label} (${e.count})</button>`).join(""),n.querySelectorAll("[data-filter]").forEach(e=>e.addEventListener("click",()=>{o.filter=e.dataset.filter,render()}))}(),renderList(),t&&(t.textContent=o.locationName)}!async function(){try{if(!window.SecureApiService||!window.SecureApiService.isAuthenticated())return void(window.location.href="business-auth.html");await Promise.all([loadLocationName(),loadReservations()]),render()}catch(e){console.error("Reservations init error:",e),alert("Eroare la încărcarea rezervărilor.")}}(),i?.querySelectorAll("[data-close]")?.forEach(e=>e.addEventListener("click",closeCancel)),l?.addEventListener("click",async()=>{null!=o.cancelTarget&&await updateStatus(o.cancelTarget,"canceled",c.value.trim()||"Fără motiv"),closeCancel(),o.cancelTarget=null})});