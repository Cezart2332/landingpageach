document.addEventListener("DOMContentLoaded",()=>{const e=new URLSearchParams(location.search).get("id");if(!e)return alert("Lipsește parametrul id al locației."),void(window.location.href="business-locations.html");const t=document.getElementById("editLocationForm"),a=document.getElementById("name"),n=document.getElementById("address"),o=document.getElementById("lat"),i=document.getElementById("lng"),l=document.getElementById("description"),r=document.getElementById("tags"),d=document.getElementById("tagsPreview"),s=document.getElementById("photoArea"),c=document.getElementById("menuBtn"),u=document.getElementById("menuStatus"),p=document.getElementById("geoBtn"),m=document.getElementById("gpsBtn"),v=document.getElementById("geoStatus"),g=document.getElementById("reservationsToggle"),f=document.getElementById("saveBtn");let y=[],h=null,E=null,L=!1;const b={loading:!1},escapeHtml=e=>(e||"").replace(/[&<>"']/g,e=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"}[e]||e)),setSaveBtn=(e,t)=>{f&&(f.innerHTML=`<i class="fas fa-save"></i> ${e}`,f.disabled=!!t)};function validate(){let e=!0;return a.value.trim()||(e=!1),n.value.trim()||(e=!1),o.value&&i.value||(e=!1),f&&(f.disabled=!e),e}function renderTags(){d.innerHTML=y.map(e=>`<span class="tag-chip">${escapeHtml(e)}<button type="button" data-del="${escapeHtml(e)}">×</button></span>`).join(""),d.querySelectorAll("[data-del]").forEach(e=>e.addEventListener("click",()=>{y=y.filter(t=>t!==e.dataset.del),renderTags(),validate()}))}function renderPhoto(e){if(!s)return;if(!e)return void(s.innerHTML='<i class="fas fa-camera" style="font-size:2rem;color:#a855f7;"></i><p style="margin:10px 0 4px;font-weight:600;color:#a855f7;">Adaugă / Înlocuiește foto</p><p style="margin:0;color:#64748b;font-size:.7rem;">Click pentru selectare (16:9)</p>');s.innerHTML=`<img src="${escapeHtml(e)}" class="photo-preview" alt="loc" loading="lazy"/><button type="button" class="remove-photo" id="removePhoto"><i class='fas fa-times'></i> Elimină</button>`;const t=document.getElementById("removePhoto");t&&t.addEventListener("click",()=>{h=null,renderPhoto("")})}r&&(r.addEventListener("input",()=>{const e=r.value;e.includes(",")&&(e.split(",").map(e=>e.trim()).filter(Boolean).forEach(e=>{!y.includes(e)&&y.length<50&&y.push(e)}),r.value="",renderTags(),validate())}),r.addEventListener("keydown",e=>{if("Enter"===e.key){e.preventDefault();const t=r.value.trim();t&&(y.includes(t)||y.push(t),r.value="",renderTags(),validate())}"Backspace"!==e.key||r.value||(y.pop(),renderTags(),validate())})),s&&s.addEventListener("click",()=>function(){const e=document.createElement("input");e.type="file",e.accept="image/*",e.onchange=()=>{const t=e.files&&e.files[0];t&&(h=t,renderPhoto(URL.createObjectURL(t)))},e.click()}()),c&&c.addEventListener("click",()=>{const e=document.createElement("input");e.type="file",e.accept="application/pdf",e.onchange=()=>{const t=e.files&&e.files[0];t&&(E=t,u&&(u.innerHTML=`<span style='color:#22c55e;font-weight:600;'>${escapeHtml(t.name)} ✓</span>`))},e.click()});function updateGeoStatus(){v&&(b.loading?v.innerHTML="<span style='color:#f59e0b;'>Obțin coordonate...</span>":o.value&&i.value?v.innerHTML=`<span style='color:#22c55e;'>Coord: ${o.value}, ${i.value}</span>`:v.innerHTML="")}p&&p.addEventListener("click",()=>{const e=n.value.trim();e?(b.loading=!0,updateGeoStatus(),fetch(`https://api.geoapify.com/v1/geocode/search?text=${encodeURIComponent(e+", Romania")}&limit=1&lang=ro&filter=countrycode:ro&apiKey=d5466dbfa4a84344b872af4009106e17`).then(e=>e.json()).then(e=>{const t=e.features&&e.features[0];if(t){const[e,a]=t.geometry.coordinates;o.value=Number(a).toFixed(6),i.value=Number(e).toFixed(6)}else alert("Adresă negăsită")}).catch(()=>alert("Eroare geocodare")).finally(()=>{b.loading=!1,updateGeoStatus(),validate()})):alert("Introdu adresa.")}),m&&m.addEventListener("click",()=>{alert("Demo GPS – valori setate."),o.value="44.426800",i.value="26.102500",updateGeoStatus(),validate()}),t&&t.addEventListener("submit",async function(t){if(t.preventDefault(),validate()){setSaveBtn('<i class="fas fa-spinner fa-spin"></i> Salvare...',!0);try{const t=new FormData;t.append("name",a.value.trim()),t.append("address",n.value.trim()),t.append("latitude",o.value.trim()),t.append("longitude",i.value.trim()),t.append("tags",y.join(", ")),t.append("description",l.value||""),t.append("reservationsEnabled",g.checked?"true":"false"),h&&t.append("photo",h,h.name||"location_photo.jpg"),E&&t.append("menu",E,E.name||"menu.pdf");const r=await(window.SecureApiService?.put(`/locations/${e}`,t)||{});if(r&&r.success)return f.innerHTML='<i class="fas fa-check"></i> Locație actualizată',void setTimeout(()=>{window.location.href=`business-location.html?id=${encodeURIComponent(e)}`},700);let d="Actualizarea a eșuat";r&&r.error&&(d=r.error?.Error||r.error?.message||d),alert(d),setSaveBtn(" Salvează Modificările",!1)}catch(e){console.error("Update error:",e),alert("Eroare de rețea la actualizare"),setSaveBtn(" Salvează Modificările",!1)}}}),["input","blur"].forEach(e=>a.addEventListener(e,validate)),n.addEventListener("input",validate),o.addEventListener("input",validate),i.addEventListener("input",validate),async function(){L=!0;try{const r=await(window.SecureApiService?.get(`/locations/${e}`)||{}),d=r&&r.success?r.data:null;if(!d)throw new Error("Nu s-au putut încărca detaliile locației");a.value=d.name||"",n.value=d.address||"",o.value=null!=d.latitude?String(d.latitude):"",i.value=null!=d.longitude?String(d.longitude):"",l.value=d.description||"",t=d.tags||(Array.isArray(d.Tags)?d.Tags.join(","):d.Tags),y=t?Array.isArray(t)?t:t.split(",").map(e=>e.trim()).filter(Boolean):[],renderTags();const s=d.reservationsEnabled??d.ReservationsEnabled;g.checked="boolean"!=typeof s||s;renderPhoto(d.photoUrl||d.photo||""),(d.hasMenu||d.HasMenu)&&u&&(u.innerHTML='<span style="color:#22c55e;font-weight:600;">Meniu existent ✅</span>')}catch(e){console.error("Load location error:",e),alert("Eroare: nu s-au putut încărca detaliile locației"),window.location.href="business-locations.html"}finally{L=!1,validate(),updateGeoStatus()}var t}()});