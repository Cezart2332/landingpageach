document.addEventListener("DOMContentLoaded",()=>{const e=document.getElementById("addLocationForm"),t=document.getElementById("name"),a=document.getElementById("nameError"),n=document.getElementById("address"),l=document.getElementById("phone"),o=document.getElementById("description"),i=document.getElementById("tags"),r=document.getElementById("tagsPreview"),d=document.getElementById("categories"),s=(document.getElementById("reservationsToggle"),document.getElementById("submitBtn")),c=document.getElementById("geoStatus"),u=document.getElementById("photoArea"),g=document.getElementById("photoInput");let m,p="",v=[],f={lat:null,lng:null,loading:!1};const y="d5466dbfa4a84344b872af4009106e17";function renderTags(){r.innerHTML=v.map(e=>`<span class="tag-chip">${e}<button type="button" data-del="${e}">×</button></span>`).join(""),r.querySelectorAll("[data-del]").forEach(e=>e.addEventListener("click",()=>{v=v.filter(t=>t!==e.dataset.del),renderTags()}))}d.innerHTML=["restaurant","pub","cafenea","club"].map(e=>`<button type="button" class="cat-pill" data-cat="${e}">${e}</button>`).join(""),d.querySelectorAll(".cat-pill").forEach(e=>{e.addEventListener("click",()=>{p=e.dataset.cat,d.querySelectorAll(".cat-pill").forEach(t=>t.classList.toggle("active",t===e)),validate()})}),i.addEventListener("input",()=>{const e=i.value;e.includes(",")&&(e.split(",").map(e=>e.trim()).filter(Boolean).forEach(e=>{!v.includes(e)&&v.length<12&&v.push(e)}),i.value="",renderTags())}),i.addEventListener("keydown",e=>{if("Enter"===e.key){e.preventDefault();const t=i.value.trim();t&&(v.includes(t)||v.push(t),i.value="",renderTags())}"Backspace"!==e.key||i.value||(v.pop(),renderTags())}),u.addEventListener("click",()=>g.click()),g.addEventListener("change",handlePhoto),u.addEventListener("dragover",e=>{e.preventDefault(),u.style.borderColor="#a855f7"}),u.addEventListener("dragleave",()=>u.style.borderColor="rgba(139,92,246,.3)"),u.addEventListener("drop",e=>{e.preventDefault(),u.style.borderColor="rgba(139,92,246,.3)",e.dataTransfer.files[0]&&(g.files=e.dataTransfer.files,handlePhoto())});let h=null;function handlePhoto(){const e=g.files&&g.files[0];if(!e)return;h=e;const t=URL.createObjectURL(e);u.innerHTML=`<img src="${t}" class="photo-preview" alt="preview"/><button type="button" class="remove-photo" id="removePhoto">Elimină fotografia</button>`,document.getElementById("removePhoto").addEventListener("click",()=>{h=null,g.value="",u.innerHTML='<i class="fas fa-camera" style="font-size:2rem;color:#a855f7;"></i><p style="margin:10px 0 4px;font-weight:600;color:#a855f7;">Adaugă o fotografie</p><p style="margin:0;color:#64748b;font-size:.7rem;">Click sau trage o imagine (16:9 recomandat)</p><input type="file" id="photoInput" accept="image/*" style="display:none;" />',document.getElementById("photoInput").addEventListener("change",handlePhoto)})}function updateGeoStatus(){f.loading?c.innerHTML='<div class="geo-status geo-loading"><i class="fas fa-hourglass-half"></i> Obțin coordonate...</div>':f.lat&&f.lng?c.innerHTML=`<div class="geo-status geo-ok"><i class="fas fa-check-circle"></i> Localizat: ${f.lat}, ${f.lng}</div>`:n.value.trim().length>=5?c.innerHTML='<div class="geo-status geo-loading" style="background:rgba(239,68,68,.1);border-color:rgba(239,68,68,.4);color:#ef4444;"><i class="fas fa-triangle-exclamation"></i> Nu s-au putut obține coordonatele</div>':c.innerHTML=""}function validate(){let e=!0;return t.value.trim()?(t.classList.remove("error"),a.style.display="none"):(t.classList.add("error"),a.style.display="block",a.textContent="Introdu numele locației.",e=!1),n.value.trim()&&f.lat||(e=!1),l.value.trim()||(e=!1),p||(e=!1),s.disabled=!e,e}n.addEventListener("input",()=>{if(m&&clearTimeout(m),n.value.trim().length<5)return f.lat=null,f.lng=null,updateGeoStatus(),void validate();m=setTimeout(()=>{return e=n.value.trim(),f.loading=!0,updateGeoStatus(),void fetch(`https://api.geoapify.com/v1/geocode/search?text=${encodeURIComponent(e+", Romania")}&limit=1&lang=ro&filter=countrycode:ro&apiKey=${y}`).then(e=>e.json()).then(e=>{const t=e.features&&e.features[0];if(t){const[e,a]=t.geometry.coordinates;f.lat=a.toFixed(6),f.lng=e.toFixed(6)}else f.lat=null,f.lng=null}).catch(()=>{f.lat=null,f.lng=null}).finally(()=>{f.loading=!1,updateGeoStatus(),validate()});var e},650)}),["input","blur"].forEach(e=>t.addEventListener(e,validate)),l.addEventListener("input",validate),o.addEventListener("input",validate),e.addEventListener("submit",e=>{e.preventDefault(),validate()&&(s.disabled=!0,s.innerHTML='<i class="fas fa-spinner fa-spin"></i> Creare...',setTimeout(()=>{alert("Locație creată cu succes (demo)."),window.location.href="business-locations.html"},900))}),validate()});