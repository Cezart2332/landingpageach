document.addEventListener("DOMContentLoaded",()=>{const e=document.querySelectorAll(".tab-btn"),t=document.querySelectorAll(".form-view"),r=document.getElementById("signupPassword"),s=document.getElementById("signupConfirm"),n=document.querySelectorAll(".password-strength span"),a=document.querySelectorAll(".requirements .r"),i=document.getElementById("certificateInput"),o=document.getElementById("fileIndicator"),c=document.getElementById("signupForm"),l=document.getElementById("loginForm"),d=document.getElementById("errorBox"),u=document.getElementById("successBox");function switchTab(r){e.forEach(e=>e.classList.toggle("active",e.dataset.tab===r)),t.forEach(e=>e.style.display=e.dataset.view===r?"block":"none"),location.hash="signup"===r?"#signup":"#login"}function evaluatePassword(e){let t=0;return e.length>=8&&t++,/[a-z]/.test(e)&&t++,/[A-Z]/.test(e)&&t++,/[0-9]/.test(e)&&t++,/[^a-zA-Z0-9]/.test(e)&&t++,t}function updateStrength(){const e=r.value,t=evaluatePassword(e);n.forEach((e,r)=>{if(r<t){let r="#ef4444";t>=3&&(r="#f59e0b"),t>=4&&(r="#3b82f6"),5===t&&(r="#10b981"),e.style.background=r}else e.style.background="#2d2d2d"});const s=[e.length>=8,/[a-z]/.test(e),/[A-Z]/.test(e),/[0-9]/.test(e),/[^a-zA-Z0-9]/.test(e)];a.forEach((e,t)=>{s[t]?(e.classList.add("valid"),e.querySelector("i").className="fas fa-check-circle"):(e.classList.remove("valid"),e.querySelector("i").className="far fa-circle")})}function showError(e){d.textContent=e,d.style.display="block",u.style.display="none"}function showSuccess(e){u.textContent=e,u.style.display="block",d.style.display="none"}e.forEach(e=>e.addEventListener("click",()=>switchTab(e.dataset.tab))),"#signup"===location.hash?switchTab("signup"):switchTab("login"),r.addEventListener("input",updateStrength),updateStrength(),i?.addEventListener("change",()=>{i.files&&i.files[0]?(o.style.display="flex",o.querySelector("span").textContent=i.files[0].name):o.style.display="none"}),document.querySelectorAll("[data-toggle-pass]").forEach(e=>{e.addEventListener("click",()=>{const t=e.getAttribute("data-toggle-pass"),r=document.getElementById(t);r&&(r.type="password"===r.type?"text":"password",e.classList.toggle("fa-eye"),e.classList.toggle("fa-eye-slash"))})}),document.querySelectorAll("input, select").forEach(e=>e.addEventListener("input",()=>{d.style.display="none"})),c.addEventListener("submit",async e=>{e.preventDefault();const t=document.getElementById("companyName"),n=document.getElementById("signupEmail"),a=document.getElementById("category"),o=t?t.value.trim():"",l=n?n.value.trim():"",d=a?a.value:"",u=r.value.trim(),m=s.value.trim(),p=i&&i.files&&i.files[0];if(!(o&&l&&d&&u&&m&&p))return void showError("Completează toate câmpurile și încarcă certificatul.");if(u!==m)return void showError("Parolele nu se potrivesc.");if(u.length<8)return void showError("Parola trebuie să aibă cel puțin 8 caractere.");if(evaluatePassword(u)<3)return void showError("Parola este prea slabă.");const f=c.querySelector(".submit-btn"),g=f.innerHTML;f.disabled=!0,f.innerHTML='<i class="fas fa-spinner fa-spin"></i> Trimitere...';try{const e=new FormData;e.append("Name",o),e.append("Email",l),e.append("Password",u),e.append("Category",d),e.append("IsActive","0"),e.append("Certificate",p);const t=await(window.SecureApiService?window.SecureApiService.registerWithFile(e):Promise.resolve({success:!1,status:0,error:"Secure API indisponibil"}));if(!t.success)return void showError(t.error||`Înregistrarea a eșuat (cod ${t.status}).`);showSuccess("Înregistrare reușită! Redirecționăm..."),setTimeout(()=>{window.location.href="business-dashboard.html"},900)}catch(e){showError("Eroare de rețea. Încearcă din nou.")}finally{f.disabled=!1,f.innerHTML=g}}),l.addEventListener("submit",async e=>{e.preventDefault();const t=document.getElementById("loginEmail"),r=document.getElementById("loginPassword"),s=t?t.value.trim():"",n=r?r.value.trim():"";if(!s)return void showError("Te rog să introduci email-ul sau username-ul.");if(!n)return void showError("Te rog să introduci parola.");if(n.length<6)return void showError("Parola trebuie să conțină cel puțin 6 caractere.");const a=l.querySelector(".submit-btn"),i=a.innerHTML;a.disabled=!0,a.innerHTML='<i class="fas fa-spinner fa-spin"></i> Autentificare...';try{const e=await(window.SecureApiService?window.SecureApiService.login({username:s,password:n}):Promise.resolve({success:!1,status:0,error:"Secure API indisponibil"}));if(401===e.status||!e.success&&401===e.status)return void showError("Email sau parolă incorectă. Verifică datele.");if(!e.success)return void showError(e.error||`Eroare la autentificare (cod ${e.status}).`);showSuccess("Autentificat! Redirecționăm..."),setTimeout(()=>{window.location.href="business-dashboard.html"},700)}catch(e){showError("Eroare de rețea. Încearcă din nou.")}finally{a.disabled=!1,a.innerHTML=i}})});