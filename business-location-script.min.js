document.addEventListener("DOMContentLoaded",()=>{const e=(()=>{try{const e=localStorage.getItem("ac_debug");return null===e||("1"===e||"true"===e||"on"===e)}catch{return!0}})(),dbg=(...t)=>{e&&console.debug("[LocationProfile]",...t)},t=document.getElementById("locationContent"),i=new URLSearchParams(location.search).get("id"),o=Number(i);if(dbg("DOMContentLoaded",{id:i,idNum:o,href:location.href}),!i)return void(t&&(t.innerHTML='<p style="color:#ef4444;font-weight:600;">ID locație lipsă.</p>'));const n={location:null,hours:[],reservations:[],loading:!0};function showLoading(){t&&(t.innerHTML='\n      <div style="display:flex;align-items:center;justify-content:center;padding:40px 0;">\n        <div class="loading-spinner" style="width:28px;height:28px;border:3px solid #e5e7eb;border-top-color:#7c3aed;border-radius:50%;animation:spin 1s linear infinite;"></div>\n        <span style="margin-left:10px;color:#64748b;">Se încarcă detaliile locației...</span>\n      </div>')}function showError(e){if(!t)return;t.innerHTML=`\n      <div class="empty-wrap">\n        <div class="empty-icon"><i class="fas fa-triangle-exclamation"></i></div>\n        <h2>Eroare</h2>\n        <p>${escapeHtml(e)}</p>\n        <div style="display:flex;gap:10px;justify-content:center;">\n          <button class="primary-btn" type="button" id="backBtn"><i class="fas fa-arrow-left"></i> Înapoi</button>\n        </div>\n      </div>`;const i=document.getElementById("backBtn");i&&i.addEventListener("click",()=>history.back())}async function loadLocation(e){try{dbg("loadLocation:GET",{url:`/locations/${e}`});const t=await(window.SecureApiService?.get(`/locations/${e}`)||{});dbg("loadLocation:resp",t);const i=t&&t.success?t.data:t;if(!i)throw new Error("Nu s-au putut încărca detaliile locației");n.location=i,dbg("loadLocation:resolved",{id:i?.id??i?.Id??i?.ID,name:i?.name??i?.Name})}catch(e){console.error("Load location error",e),n.location=null}}async function loadHours(e){try{dbg("loadHours:GET",{url:`/locations/${e}/hours`});const t=await(window.SecureApiService?.get(`/locations/${e}/hours`)||{});dbg("loadHours:resp",t);const i=function(e){if(!e)return[];if(e&&"object"==typeof e&&"success"in e&&"data"in e){const t=e.data;return Array.isArray(t)?t:t&&Array.isArray(t.items)?t.items:t&&Array.isArray(t.hours)?t.hours:t&&Array.isArray(t.Hours)?t.Hours:[]}return Array.isArray(e)?e:e&&Array.isArray(e.items)?e.items:e&&Array.isArray(e.hours)?e.hours:e&&Array.isArray(e.Hours)?e.Hours:[]}(t);dbg("loadHours:extracted",i);const o=Array.isArray(i)?i.map(mapBackendHour).filter(Boolean):[];dbg("loadHours:mapped",o);const a=[0,1,2,3,4,5,6];n.hours=a.map(e=>o.find(t=>t.day===e)||{day:e,isOpen:!0,is24:!1,open:"09:00",close:"22:00"}),dbg("loadHours:finalNormalized7",n.hours)}catch(e){console.warn("Hours load failed, using defaults",e),n.hours=Array.from({length:7},(e,t)=>({day:t,isOpen:!0,is24:!1,open:"09:00",close:"22:00"})),dbg("loadHours:defaultsUsed",n.hours)}}async function loadRecentReservations(e){try{dbg("loadRecentReservations:GET",{url:`/locations/${e}/reservations?limit=3`});let t=await(window.SecureApiService?.get(`/locations/${e}/reservations?limit=3`)||{});dbg("loadRecentReservations:resp1",t);let i=t&&t.success?t.data:t;Array.isArray(i)||(dbg("loadRecentReservations:fallbackGET",{url:`/reservations?locationId=${encodeURIComponent(e)}&limit=3`}),t=await(window.SecureApiService?.get(`/reservations?locationId=${encodeURIComponent(e)}&limit=3`)||{}),dbg("loadRecentReservations:resp2",t),i=t&&t.success?t.data:t),n.reservations=Array.isArray(i)?i:[],dbg("loadRecentReservations:final",{count:n.reservations.length})}catch(e){console.warn("Reservations load failed",e),n.reservations=[],dbg("loadRecentReservations:errorEmpty")}}function render(){if(dbg("render:start",{hasRoot:!!t,hasLocation:!!n.location,hours:n.hours.length,reservations:n.reservations.length}),!t||!n.location)return void showError("Detaliile locației nu sunt disponibile.");const e=n.location,o=e.id||e.Id||e.ID||Number(i),a=e.name||e.Name||"Locație",s=e.address||e.Address||e.location||"Adresă necunoscută",r=e.tags||e.Tags||[],c=Array.isArray(r)?r:"string"==typeof r?r.split(","):[],l=e.photoUrl||e.photo||e.imageUrl||e.ImageUrl||"https://picsum.photos/seed/lprof"+i+"/1200/800",d=function(e){try{const t=(new Date).getDay(),i=e.find(e=>e.day===t),o=i&&i.isOpen?`${formatTime12(i.open)} - ${formatTime12(i.close)}`:"Închis azi";return dbg("todayHoursText",{today:t,h:i,txt:o}),o}catch{return"Închis azi"}}(n.hours);dbg("render:todayText",d),t.innerHTML=`\n      <div class="hero-card">\n        <div class="hero-media"><img src="${escapeHtml(l)}" alt="${escapeHtml(a)}" loading="lazy"/></div>\n        <h1 class="loc-title">${escapeHtml(a)}</h1>\n        <div class="address-line"><i class="fas fa-location-dot" style="color:#7c3aed;"></i><span>${escapeHtml(s)}</span></div>\n        <div class="tag-badges">${c.map(e=>`<span class='tag'>${escapeHtml(String(e).trim())}</span>`).join("")}</div>\n        <div class="today-hours"><i class="fas fa-clock"></i> ${d}</div>\n      </div>\n      <div class="actions-row">\n        <button class="action-btn" id="hoursBtn"><i class="fas fa-clock"></i> Program</button>\n        <button class="action-btn" id="editBtn"><i class="fas fa-pen"></i> Editează</button>\n        <button class="action-btn green" id="reservationsBtn"><i class="fas fa-calendar"></i> Rezervări</button>\n      </div>\n      <div class="stats-grid">\n        <div class="stat-card"><div class="number">${n.reservations.length}</div><div style="color:#9ca3af;font-size:.65rem;letter-spacing:.5px;font-weight:600;">REZERVĂRI</div></div>\n        <div class="stat-card p2"><div class="number">${n.hours.filter(e=>e.isOpen).length}</div><div style="color:#9ca3af;font-size:.65rem;letter-spacing:.5px;font-weight:600;">ZILE DESCHIS</div></div>\n      </div>\n      ${n.reservations.length?`<div class="reservations-list"><h3 class="section-title">Rezervări Recente</h3>${n.reservations.slice(0,3).map(e=>function(e){const t=(e.status||e.Status||"").toString().toLowerCase(),i=e.customerName||e.CustomerName||e.name||"Client",o=e.reservationDate||e.date||e.Date||e.createdAt||"",n=e.timeSlot||e.time||e.Time||"",a=e.numberOfPeople||e.people||e.People||e.partySize||"",s="confirmed"===t?"status-confirmed":"pending"===t?"status-pending":"canceled"===t||"cancelled"===t?"status-cancelled":"",r=o?new Date(o).toLocaleDateString("ro-RO"):"";return`<div class="reservation-item">\n      <div class="reservation-item-header"><div style='font-weight:600;'>${escapeHtml(i)}</div><span class="status-chip ${s}">${escapeHtml(t.toUpperCase()||"—")}</span></div>\n      <div style='font-size:.65rem;color:#9ca3af;'>${escapeHtml(r)} ${n?"la "+escapeHtml(n):""}</div>\n      <div style='font-size:.65rem;color:#9ca3af;'>${escapeHtml(String(a))} persoane</div>\n    </div>`}(e)).join("")}<button class="action-btn" style="flex:1 1 100%;margin-top:4px;" id="allReservations"><i class='fas fa-list'></i> Toate Rezervările</button></div>`:""}\n      <div class="hours-table"><h3 class="section-title">Program Săptămânal</h3>${n.hours.map(e=>function(e){const t=["Duminică","Luni","Marți","Miercuri","Joi","Vineri","Sâmbătă"],i=e.isOpen?`${formatTime12(e.open)} - ${formatTime12(e.close)}`:"Închis";return`<div class="hours-row"><div class="hours-day">${t[e.day]}</div><div class="hours-range ${e.isOpen?"hours-open":"hours-closed"}">${i}</div></div>`}(e)).join("")}</div>\n      <div class="danger-bar"><div><strong style="color:#ef4444;">Atenție!</strong><div style="font-size:.7rem;color:#b8b8b8;margin-top:4px;">Ștergerea locației este permanentă și nu poate fi anulată.</div></div><button id="deleteBtn"><i class="fas fa-trash"></i> Șterge Locația</button></div>\n    `,document.getElementById("hoursBtn")?.addEventListener("click",()=>{dbg("nav:hours",{id:o}),window.location.href="business-location-hours.html?id="+o}),document.getElementById("editBtn")?.addEventListener("click",()=>{dbg("nav:edit",{id:o}),window.location.href="business-edit-location.html?id="+o}),document.getElementById("reservationsBtn")?.addEventListener("click",()=>{dbg("nav:reservations",{id:o}),window.location.href="business-reservations.html?id="+o}),document.getElementById("allReservations")?.addEventListener("click",()=>{dbg("nav:reservationsAll",{id:o}),window.location.href="business-reservations.html?id="+o}),document.getElementById("deleteBtn")?.addEventListener("click",onDelete),dbg("render:done")}async function onDelete(){if(window.confirm("Sigur ștergi această locație?"))try{dbg("delete:call",{url:`/locations/${i}`}),await window.SecureApiService.delete(`/locations/${i}`),dbg("delete:success"),alert("Locația a fost ștearsă."),window.location.href="business-locations.html"}catch(e){console.error("Delete failed",e),dbg("delete:error",e),alert("Ștergerea locației a eșuat.")}}function formatTime12(e){if(!e)return"";const[t,i]=String(e).split(":"),o=parseInt(t,10)||0;return`${o%12||12}:${i??"00"} ${o>=12?"PM":"AM"}`}function mapBackendHour(e){if(!e)return null;const t={...e};let i=0;if("number"==typeof e.DayOfWeek)i=e.DayOfWeek;else if("number"==typeof e.dayOfWeek)i=e.dayOfWeek;else if("string"==typeof e.DayOfWeek){const t=parseInt(e.DayOfWeek,10);if(isNaN(t)){const t=["Duminică","Luni","Marți","Miercuri","Joi","Vineri","Sâmbătă"].findIndex(t=>t.toLowerCase()===e.DayOfWeek.toLowerCase());i=t>=0?t:0}else i=t}else if("string"==typeof e.dayOfWeek){const t=parseInt(e.dayOfWeek,10);if(isNaN(t)){const t=["Duminică","Luni","Marți","Miercuri","Joi","Vineri","Sâmbătă"].findIndex(t=>t.toLowerCase()===e.dayOfWeek.toLowerCase());i=t>=0?t:0}else i=t}else"number"==typeof e.day&&(i=e.day);i>=1&&i<=7&&(i%=7),(i<0||i>6)&&(i=0);const o=!(!e.IsClosed&&!e.isClosed),n=e.OpenTime||e.open||"",a=e.CloseTime||e.close||"",s=!o&&(!0===e.Is24Hours||!0===e.is24||"00:00"===n&&("23:59"===a||"24:00"===a)),r={day:i,isOpen:!o,is24:s,open:s?"00:00":n||"09:00",close:s?"23:59":a||"22:00"};return dbg("mapBackendHour",{original:t,normalized:r}),r}function escapeHtml(e){return String(e).replace(/[&<>"]/g,e=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;"}[e]))}!async function(){try{if(dbg("init:start",{hasApi:!!window.SecureApiService,isAuth:!!window.SecureApiService?.isAuthenticated?.()}),!window.SecureApiService||!window.SecureApiService.isAuthenticated())return dbg("auth:missing -> redirect to business-auth.html"),void(window.location.href="business-auth.html");showLoading(),await Promise.all([loadLocation(o),loadHours(o),loadRecentReservations(o)]),dbg("init:data-loaded",{hasLocation:!!n.location,hours:n.hours.length,reservations:n.reservations.length}),render()}catch(e){console.error("Location init error:",e),showError("A apărut o eroare la încărcarea locației.")}finally{n.loading=!1,dbg("init:done")}}(),window.locationProfileDebug={get state(){return n},reload:async()=>{try{dbg("manualReload:start"),showLoading(),await Promise.all([loadLocation(o),loadHours(o),loadRecentReservations(o)]),render(),dbg("manualReload:done")}catch(e){console.error("manualReload:error",e)}},goHours:()=>{const e=n.location?.id??n.location?.Id??o;dbg("debugNav:hours",{id:e}),window.location.href="business-location-hours.html?id="+e},goEdit:()=>{const e=n.location?.id??n.location?.Id??o;dbg("debugNav:edit",{id:e}),window.location.href="business-edit-location.html?id="+e},goReservations:()=>{const e=n.location?.id??n.location?.Id??o;dbg("debugNav:reservations",{id:e}),window.location.href="business-reservations.html?id="+e}}});