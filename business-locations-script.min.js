document.addEventListener("DOMContentLoaded",()=>{const n=document.getElementById("locationsContent"),t={companyId:null,locations:[],loading:!0};async function fetchAndRender(){t.loading=!0,showLoading();try{const e=await async function(n){try{const t=`/companies/${n}/locations`;console.log("Fetching locations from:",t);const e=await window.SecureApiService.get(t);return null==e?[]:e}catch(n){return console.error("Error fetching locations:",n),[]}}(t.companyId);t.locations=Array.isArray(e)?e:[],t.locations.length?function(t){const e=`\n      <div class="locations-header">\n        <div style="flex:1;min-width:240px;">\n          <h2 style="margin:0 0 4px;font-size:1.6rem;">Locațiile Tale</h2>\n          <p style="margin:0;color:var(--text-secondary);font-size:.85rem;">${t.length} rezultate</p>\n        </div>\n        <div class="count-badge">${t.length} LOC</div>\n        <div style="display:flex;gap:10px;">\n          <button class="primary-btn" type="button" id="refreshBtn"><i class="fas fa-rotate"></i></button>\n          <button class="primary-btn" type="button" id="addBtn"><i class="fas fa-plus"></i> <span style="margin-left:6px;">Adaugă Locație</span></button>\n        </div>\n      </div>`,a=t.map(n=>function(n){const t=n.id||n.Id||n.ID,e=n.name||n.Name||"Locație",a=n.address||n.Address||n.location||"Adresă necunoscută",i=!!(n.hasMenu||n.menuAvailable||n.MenuAvailable),o=n.tags||n.Tags||[],s=(Array.isArray(o)?o:"string"==typeof o?o.split(","):[]).map(n=>`<span class="tag">${escapeHtml(String(n).trim())}</span>`).join(""),c=n.photo||n.imageUrl||n.ImageUrl||"https://picsum.photos/seed/acoomh-loc/600/400";return`<div class="location-card" data-view="${t}">\n      <div class="card-actions">\n        <button class="icon-btn" data-edit="${t}" title="Editează"><i class="fas fa-pen"></i></button>\n        <button class="icon-btn danger" data-delete="${t}" title="Șterge"><i class="fas fa-trash"></i></button>\n      </div>\n      <img src="${c}" alt="${escapeHtml(e)}" class="loc-photo" loading="lazy"/>\n      <h4>${escapeHtml(e)}</h4>\n      <div class="loc-address"><i class="fas fa-location-dot"></i><span>${escapeHtml(a)}</span></div>\n      <div class="tags">${s}</div>\n      <div class="loc-footer">\n        <div class="status-wrap"><span class="status-dot" style="background:${i?"#10b981":"#6b7280"}"></span>${i?"Meniu Disponibil":"Fără Meniu"}</div>\n        <button class="btn-inline" data-hours="${t}">Program</button>\n      </div>\n    </div>`}(n)).join(""),i='<div class="add-more" id="addMore"><i class="fas fa-plus-circle"></i> Adaugă altă locație</div>';n.innerHTML=e+`<div class="cards-grid">${a}</div>`+i,bindHeaderActions(),n.querySelectorAll("[data-edit]").forEach(n=>n.addEventListener("click",()=>window.location.href="business-edit-location.html?id="+n.dataset.edit)),n.querySelectorAll("[data-view]").forEach(n=>n.addEventListener("click",()=>window.location.href="business-location.html?id="+n.dataset.view)),n.querySelectorAll("[data-delete]").forEach(n=>n.addEventListener("click",()=>async function(n){if(!n)return;if(!window.confirm("Ștergi locația #"+n+"?"))return;try{await window.SecureApiService.delete(`/locations/${n}`),await fetchAndRender()}catch(n){console.error("Delete failed",n),alert("Ștergerea locației a eșuat.")}}(n.dataset.delete))),n.querySelectorAll("[data-hours]").forEach(n=>n.addEventListener("click",()=>window.location.href="business-location-hours.html?id="+n.dataset.hours))}(t.locations):function(){n.innerHTML='\n      <div class="locations-header">\n        <div style="flex:1;min-width:240px;">\n          <h2 style="margin:0 0 4px;font-size:1.6rem;">Locațiile Tale</h2>\n          <p style="margin:0;color:var(--text-secondary);font-size:.85rem;">0 rezultate</p>\n        </div>\n        <div class="count-badge">0 LOC</div>\n        <button class="primary-btn" type="button" id="addBtn"><i class="fas fa-plus"></i> <span style="margin-left:6px;">Adaugă Locație</span></button>\n      </div>\n      <div class="empty-wrap">\n        <div class="empty-icon"><i class="fas fa-location-dot"></i></div>\n        <h2>Nu există locații încă</h2>\n        <p>Adaugă prima ta locație pentru a începe să îți gestionezi prezența comercială.</p>\n        <button class="primary-btn" type="button" id="addBtn2"><i class="fas fa-plus"></i> Adaugă Locație</button>\n      </div>',bindHeaderActions();const t=document.getElementById("addBtn2");t&&t.addEventListener("click",()=>window.location.href="business-add-location.html")}()}catch(n){console.error("fetchAndRender error:",n),showError("Nu s-au putut încărca locațiile.")}finally{t.loading=!1}}function showLoading(){n.innerHTML='\n      <div class="locations-header">\n        <div style="flex:1;min-width:240px;">\n          <h2 style="margin:0 0 4px;font-size:1.6rem;">Locațiile Tale</h2>\n          <p style="margin:0;color:var(--text-secondary);font-size:.85rem;">Se încarcă...</p>\n        </div>\n        <button class="primary-btn" type="button" id="addBtn"><i class="fas fa-plus"></i><span style="margin-left:6px;"> Adaugă Locație</span></button>\n      </div>\n      <div class="loading-state" style="display:flex;align-items:center;justify-content:center;padding:40px 0;">\n        <div class="loading-content">\n          <div class="loading-spinner" style="width:28px;height:28px;border:3px solid #e5e7eb;border-top-color:#7c3aed;border-radius:50%;animation:spin 1s linear infinite;"></div>\n          <p style="margin-top:10px;color:#64748b;font-size:.9rem;">Se încarcă locațiile...</p>\n        </div>\n      </div>';const t=document.getElementById("addBtn");t&&t.addEventListener("click",()=>window.location.href="business-add-location.html")}function showError(t){n.innerHTML=`\n      <div class="empty-wrap">\n        <div class="empty-icon"><i class="fas fa-triangle-exclamation"></i></div>\n        <h2>Eroare</h2>\n        <p>${escapeHtml(t)}</p>\n        <div style="display:flex;gap:10px;justify-content:center;">\n          <button class="primary-btn" type="button" id="retryBtn"><i class="fas fa-rotate"></i> Încearcă din nou</button>\n          <button class="primary-btn" type="button" id="addBtn"><i class="fas fa-plus"></i> Adaugă Locație</button>\n        </div>\n      </div>`,bindHeaderActions()}function bindHeaderActions(){const n=document.getElementById("addBtn"),t=document.getElementById("refreshBtn"),e=document.getElementById("retryBtn");n&&n.addEventListener("click",()=>window.location.href="business-add-location.html"),t&&t.addEventListener("click",()=>fetchAndRender()),e&&e.addEventListener("click",()=>fetchAndRender());const a=document.getElementById("addMore");a&&a.addEventListener("click",()=>window.location.href="business-add-location.html")}function escapeHtml(n){return String(n).replace(/[&<>"]/g,n=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;"}[n]))}!async function(){console.log("📍 LOCATIONS init"),showLoading();try{if(!window.SecureApiService||!window.SecureApiService.isAuthenticated())return window.location.href="business-auth.html";await(n=150,new Promise(t=>setTimeout(t,n)));const e=await async function(){try{return await window.SecureApiService.getProfile()}catch(n){return console.warn("getProfile failed:",n),null}}(),a=function(n){return n&&(n.id||n.Id||n.companyId||n.CompanyId||n.company&&(n.company.id||n.company.Id))||null}(e);if(!a)return console.warn("Could not determine company id from profile:",e),void showError("Nu s-a putut identifica compania. Reautentifică-te.");t.companyId=a,await fetchAndRender()}catch(n){console.error("LOCATIONS init error:",n),showError("A apărut o eroare la încărcarea locațiilor. Încearcă din nou.")}var n}()});