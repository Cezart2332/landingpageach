document.addEventListener("DOMContentLoaded",()=>{const e=(()=>{try{const e=localStorage.getItem("ac_debug");return null===e||("1"===e||"true"===e||"on"===e)}catch{return!0}})(),dbg=(...t)=>{e&&console.debug("[AddLocation]",...t)};function dumpStorages(e){try{const t={};for(let e=0;e<sessionStorage.length;e++){const a=sessionStorage.key(e);a&&(t[a]=sessionStorage.getItem(a))}const a={};for(let e=0;e<localStorage.length;e++){const t=localStorage.key(e);t&&(a[t]=localStorage.getItem(t))}console.log("[AddLocation] storageSnapshot",{where:e,sessionStorage:t,localStorage:a})}catch(e){console.warn("[AddLocation] storageSnapshot:error",e)}}const t=document.getElementById("addLocationForm"),a=document.getElementById("name"),o=document.getElementById("nameError"),n=document.getElementById("address"),r=document.getElementById("phone"),i=document.getElementById("description"),l=document.getElementById("tags"),s=document.getElementById("tagsPreview"),c=document.getElementById("categories"),d=document.getElementById("reservationsToggle"),u=document.getElementById("submitBtn"),m=document.getElementById("geoStatus"),p=document.getElementById("photoArea"),g=document.getElementById("photoInput");let f,y=null,v="",h=[],b=null;const L={lat:null,lng:null,loading:!1},E=["restaurant","pub","cafenea","club"];function escapeHtml(e){return String(e).replace(/[&<>"']/g,e=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;"}[e]))}function setSubmit(e,t){u&&(u.innerHTML=e,u.disabled=!!t)}function renderTags(){s.innerHTML=h.map(e=>`<span class="tag-chip">${escapeHtml(e)}<button type="button" data-del="${escapeHtml(e)}">×</button></span>`).join(""),s.querySelectorAll("[data-del]").forEach(e=>e.addEventListener("click",()=>{h=h.filter(t=>t!==e.dataset.del),renderTags(),validate()}))}function handlePhoto(){const e=g.files&&g.files[0];if(!e)return;b=e;const t=URL.createObjectURL(e);p.innerHTML=`<img src="${t}" class="photo-preview" alt="preview"/><button type="button" class="remove-photo" id="removePhoto">Elimină fotografia</button>`;const a=document.getElementById("removePhoto");a&&a.addEventListener("click",()=>{b=null,g.value="",p.innerHTML='<i class="fas fa-camera" style="font-size:2rem;color:#a855f7;"></i><p style="margin:10px 0 4px;font-weight:600;color:#a855f7;">Adaugă o fotografie</p><p style="margin:0;color:#64748b;font-size:.7rem;">Click sau trage o imagine (16:9 recomandat)</p><input type="file" id="photoInput" accept="image/*" style="display:none;" />',document.getElementById("photoInput").addEventListener("change",handlePhoto)})}function updateGeoStatus(){m&&(L.loading?m.innerHTML='<div class="geo-status geo-loading"><i class="fas fa-hourglass-half"></i> Obțin coordonate...</div>':L.lat&&L.lng?m.innerHTML=`<div class="geo-status geo-ok"><i class="fas fa-check-circle"></i> Localizat: ${L.lat}, ${L.lng}</div>`:n.value.trim().length>=5?m.innerHTML='<div class="geo-status geo-loading" style="background:rgba(239,68,68,.1);border-color:rgba(239,68,68,.4);color:#ef4444;"><i class="fas fa-triangle-exclamation"></i> Nu s-au putut obține coordonatele</div>':m.innerHTML="")}function validate(){let e=!0;return a.value.trim()?(a.classList.remove("error"),o.style.display="none"):(a.classList.add("error"),o.style.display="block",o.textContent="Introdu numele locației.",e=!1),n.value.trim()&&L.lat&&L.lng||(e=!1),r.value.trim()||(e=!1),v||(e=!1),u&&(u.disabled=!e),e}async function safeProfile(){try{const e=await window.SecureApiService.getProfile();return dbg("getProfile:resp",e),e&&"object"==typeof e&&"success"in e&&"data"in e?e.data:e}catch(e){return dbg("getProfile:error",e),null}}function extractCompanyId(e){if(!e)return null;const t=e.id||e.Id||e.companyId||e.CompanyId||e.company&&(e.company.id||e.company.Id)||null;return dbg("extractCompanyId",{profile:e,cid:t}),t}c&&(c.innerHTML=E.map(e=>`<button type="button" class="cat-pill" data-cat="${e}">${e}</button>`).join(""),c.querySelectorAll(".cat-pill").forEach(e=>{e.addEventListener("click",()=>{v=e.dataset.cat,c.querySelectorAll(".cat-pill").forEach(t=>t.classList.toggle("active",t===e)),validate()})})),dumpStorages("DOMContentLoaded"),l&&(l.addEventListener("input",()=>{const e=l.value;e.includes(",")&&(e.split(",").map(e=>e.trim()).filter(Boolean).forEach(e=>{!h.includes(e)&&h.length<50&&h.push(e)}),l.value="",renderTags(),validate())}),l.addEventListener("keydown",e=>{if("Enter"===e.key){e.preventDefault();const t=l.value.trim();t&&(h.includes(t)||h.push(t),l.value="",renderTags(),validate())}"Backspace"!==e.key||l.value||(h.pop(),renderTags(),validate())})),p&&p.addEventListener("click",()=>g.click()),g&&g.addEventListener("change",handlePhoto),p&&(p.addEventListener("dragover",e=>{e.preventDefault(),p.style.borderColor="#a855f7"}),p.addEventListener("dragleave",()=>p.style.borderColor="rgba(139,92,246,.3)"),p.addEventListener("drop",e=>{e.preventDefault(),p.style.borderColor="rgba(139,92,246,.3)",e.dataTransfer.files[0]&&(g.files=e.dataTransfer.files,handlePhoto())})),n&&n.addEventListener("input",()=>{f&&clearTimeout(f);const e=n.value.trim();if(e.length<5)return L.lat=null,L.lng=null,updateGeoStatus(),void validate();f=setTimeout(()=>{return t=e,L.loading=!0,updateGeoStatus(),void fetch(`https://api.geoapify.com/v1/geocode/search?text=${encodeURIComponent(t+", Romania")}&limit=1&lang=ro&filter=countrycode:ro&apiKey=d5466dbfa4a84344b872af4009106e17`).then(e=>e.json()).then(e=>{const t=e.features&&e.features[0];if(t){const[e,a]=t.geometry.coordinates;L.lat=Number(a).toFixed(6),L.lng=Number(e).toFixed(6)}else L.lat=null,L.lng=null}).catch(()=>{L.lat=null,L.lng=null}).finally(()=>{L.loading=!1,updateGeoStatus(),validate()});var t},650)}),["input","blur"].forEach(e=>a.addEventListener(e,validate)),r&&r.addEventListener("input",validate),i&&i.addEventListener("input",validate),t&&t.addEventListener("submit",async e=>{if(e.preventDefault(),validate()){setSubmit('<i class="fas fa-spinner fa-spin"></i> Creare...',!0);try{if(dumpStorages("submit"),!y){const e=await safeProfile();y=extractCompanyId(e),console.log("[AddLocation] companyId:resolvedOnSubmit",{companyId:y})}if(!y)throw new Error("Nu s-a putut identifica compania.");const e=a.value.trim(),t=await async function(e,t){try{const a=await window.SecureApiService.get(`/companies/${e}/locations`);return(a&&a.success&&Array.isArray(a.data)?a.data:Array.isArray(a)?a:[]).some(e=>(e.name||e.Name||"").toLowerCase()===t.toLowerCase())}catch(e){return console.warn("Name check failed:",e),!1}}(y,e);if(t)return o.style.display="block",o.textContent="O locație cu acest nume există deja. Alege un nume diferit.",alert("Nume Locație Duplicat: O locație cu acest nume există deja pentru compania ta."),void setSubmit('<i class="fas fa-plus-circle"></i> Creează Locație',!1);const l=Number(L.lat),s=Number(L.lng);if(!Number.isFinite(l)||!Number.isFinite(s))return alert("Coordonatele nu sunt valide. Reintrodu adresa."),void setSubmit('<i class="fas fa-plus-circle"></i> Creează Locație',!1);const c=new FormData;c.append("name",e),c.append("address",n.value.trim()),c.append("category",v),c.append("phoneNumber",r.value.trim()),c.append("latitude",l.toFixed(6)),c.append("longitude",s.toFixed(6)),c.append("tags",h.join(", ")),c.append("description",i.value||""),c.append("reservationsEnabled",d.checked?"true":"false"),b&&c.append("photo",b,b.name||"location_photo.jpg");try{const e={};for(const[t,a]of c.entries())e[t]=a instanceof File?{name:a.name,size:a.size,type:a.type}:a;console.log("[AddLocation] submit:payloadPreview",e)}catch{}const u=await window.SecureApiService.post(`/companies/${y}/locations`,c);if(u&&u.success)return alert("Locația a fost adăugată cu succes!"),void(window.location.href="business-locations.html");let m="Adăugarea locației a eșuat";if(u&&u.error&&(m=u.error?.detail||u.error?.Error||u.error?.message||m,409===u.status))return alert("Nume Locație Duplicat: "+m),void setSubmit('<i class="fas fa-plus-circle"></i> Creează Locație',!1);alert(m),setSubmit('<i class="fas fa-plus-circle"></i> Creează Locație',!1)}catch(e){console.error("Create location error:",e),dbg("submit:error",e),alert("Eroare: adăugarea locației a eșuat"),setSubmit('<i class="fas fa-plus-circle"></i> Creează Locație',!1)}}}),async function(){try{try{const e=sessionStorage.getItem("company"),t=localStorage.getItem("company"),a=e||t;if(a)try{const e=JSON.parse(a),t=e?.id||e?.Id;t&&(y=t),dbg("initCompany:fromStorage",{cid:t})}catch{}}catch{}if(!y){const e=await safeProfile();y=extractCompanyId(e)}console.log("[AddLocation] initCompany:resolved",{companyId:y}),dumpStorages("initCompany")}catch{}}(),validate();try{window.addLocationDebug={dump:()=>dumpStorages("manual"),getCompanyId:()=>y,getGeo:()=>({...L}),getFormState:()=>({name:a?.value,address:n?.value,phone:r?.value,category:v,tags:[...h],hasPhoto:!!b})},console.log("[AddLocation] debug helpers ready: window.addLocationDebug")}catch{}});