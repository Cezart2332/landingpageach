document.addEventListener("DOMContentLoaded",()=>{const e=(()=>{try{const e=localStorage.getItem("ac_debug");return null===e||("1"===e||"true"===e||"on"===e)}catch{return!0}})(),dbg=(...a)=>{e&&console.debug("[HoursEditor]",...a)},inf=(...e)=>console.log("[HoursEditor]",...e),a=document.getElementById("daysWrap"),t=document.getElementById("saveHoursBtn"),n=new URLSearchParams(location.search).get("id"),r=document.getElementById("locNameSub"),o=document.getElementById("quickActions"),s=n?`Locație #${n}`:"Locație";dbg("init",{locationId:n,href:location.href}),inf("init",{locationId:n,href:location.href}),r&&(r.textContent=s);const i=[{value:0,label:"Duminică"},{value:1,label:"Luni"},{value:2,label:"Marți"},{value:3,label:"Miercuri"},{value:4,label:"Joi"},{value:5,label:"Vineri"},{value:6,label:"Sâmbătă"}];let l=i.map(e=>({day:e.value,isOpen:!0,is24:!1,open:"09:00",close:"22:00"})),c=!1,d=null,u=null;function markDirty(){c=!0,t&&(t.disabled=!1),dbg("markDirty",{dirty:c})}function formatDisp(e){const[a,t]=e.split(":"),n=parseInt(a||"0",10);return`${n%12||12}:${t??"00"} ${n>=12?"PM":"AM"}`}function dayCard(e){const a=i.find(a=>a.value===e.day)?.label??"";return`<div class="day-card" data-day="${e.day}">\n      <div class="day-head">\n        <h4>${a}</h4>\n        <label class="switch"><input type="checkbox" data-open-toggle ${e.isOpen?"checked":""}><span class="slider"></span></label>\n      </div>\n      <div class="day-body">${e.isOpen?function(e){return`<div class="block">\n        <label>24H NON‑STOP</label>\n        <button type="button" class="toggle-24 ${e.is24?"active":""}" data-24>${e.is24?'<i class="fas fa-check"></i> Activ':"Activează"}</button>\n      </div>\n      ${e.is24?"":`<div class="block">\n        <label>DESCHIDE</label>\n        <button type="button" class="time-btn" data-time="open"> <i class="fas fa-clock"></i> ${formatDisp(e.open)}</button>\n      </div>\n      <div class="block">\n        <label>ÎNCHIDE</label>\n        <button type="button" class="time-btn" data-time="close"> <i class="fas fa-clock"></i> ${formatDisp(e.close)}</button>\n      </div>`}`}(e):"<div class='closed-label'>ÎNCHIS</div>"}</div>\n    </div>`}function render(){a&&(dbg("render",{hours:l}),inf("render",{count:l.length}),a.innerHTML=l.map(e=>dayCard(e)).join(""),function(){if(!a)return;a.querySelectorAll("[data-open-toggle]").forEach(e=>{e.addEventListener("change",a=>{const t=(a.target instanceof HTMLElement?a.target:e).closest(".day-card"),n=Number(t?.getAttribute("data-day")),r=l.find(e=>e.day===n);r&&(r.isOpen=a.target instanceof HTMLInputElement?!!a.target.checked:!r.isOpen,dbg("toggleOpen",{day:n,isOpen:r.isOpen}),r.isOpen||(r.is24=!1),markDirty(),render())})}),a.querySelectorAll("[data-24]").forEach(e=>{e.addEventListener("click",a=>{const t=(a.target instanceof HTMLElement?a.target:e).closest(".day-card"),n=Number(t?.getAttribute("data-day")),r=l.find(e=>e.day===n);r&&(r.is24=!r.is24,dbg("toggle24",{day:n,is24:r.is24}),r.is24&&(r.open="00:00",r.close="23:59"),markDirty(),render())})}),a.querySelectorAll("[data-time]").forEach(e=>{e.addEventListener("click",()=>{const a=e.closest(".day-card"),t=Number(a?.getAttribute("data-day")),n=e.getAttribute("data-time");n&&(dbg("openTimePicker",{day:t,field:n}),function(e,a){if(!(p&&y&&f&&m))return;g.day=e,g.field=a,g.value=null,function(){if(!y)return;y.innerHTML="";const e=new Date;e.setHours(0,0,0,0);for(let a=0;a<48;a++){const t=new Date(e.getTime()+30*a*6e4),n=`${t.getHours().toString().padStart(2,"0")}:${t.getMinutes().toString().padStart(2,"0")}`,r=document.createElement("div");r.className="tm-item",r.innerHTML=`<span>${formatDisp(n)}</span><i class="fas fa-clock" style="opacity:.4;"></i>`,r.dataset.val=n,r.addEventListener("click",()=>{g.value=n,y.querySelectorAll(".tm-item").forEach(e=>e.classList.toggle("active",e.getAttribute("data-val")===n)),r.classList.add("active"),dbg("timePicker:select",{val:n})}),y.appendChild(r)}}(),m.textContent="Selectează ora de "+("open"===a?"deschidere":"închidere"),dbg("timePicker:open",{day:e,field:a}),p.style.display="flex"}(t,n))})})}())}!function(){try{const e={};for(let a=0;a<sessionStorage.length;a++){const t=sessionStorage.key(a);t&&(e[t]=sessionStorage.getItem(t))}const a={};for(let e=0;e<localStorage.length;e++){const t=localStorage.key(e);t&&(a[t]=localStorage.getItem(t))}inf("storageSnapshot",{sessionStorage:e,localStorage:a})}catch(e){console.warn("[HoursEditor] storageSnapshot:error",e)}}(),o&&o.querySelectorAll("[data-action]").forEach(e=>{e.addEventListener("click",()=>{const a=e.getAttribute("data-action");"nonstop"===a?l=l.map(e=>({...e,isOpen:!0,is24:!0,open:"00:00",close:"23:59"})):"openall"===a?l=l.map(e=>({...e,isOpen:!0,is24:!1,open:"09:00",close:"22:00"})):"closeall"===a?l=l.map(e=>({...e,isOpen:!1,is24:!1})):"weekdays"===a?l=l.map(e=>({...e,isOpen:e.day>=1&&e.day<=5,is24:!1,open:"09:00",close:"18:00"})):"weekend"===a&&(l=l.map(e=>({...e,isOpen:0===e.day||6===e.day,is24:!1,open:"10:00",close:"23:00"}))),dbg("quickAction",{action:a,hours:l}),markDirty(),render()})});const p=document.getElementById("timeModal"),y=document.getElementById("tmList"),f=document.getElementById("tmConfirm"),m=document.getElementById("tmTitle"),g={day:null,field:null,value:null};function extractList(e){try{if(!e)return[];if(Array.isArray(e))return e;if(e.success){if(Array.isArray(e.data))return e.data;if(e.data&&Array.isArray(e.data.items))return e.data.items}return[]}catch{return[]}}async function resolveCompanyId(){if(d)return d;try{const e=sessionStorage.getItem("company")||localStorage.getItem("company");if(e)try{const a=JSON.parse(e),t=a?.id||a?.Id;if(t)return d=t,inf("companyId:fromStorage",{companyId:d}),d}catch{}}catch{}try{const e=await(window.SecureApiService?.getProfile()||{}),a=e&&e.success?e.data:e,t=a?.id||a?.Id||a?.companyId||a?.CompanyId||a?.company?.id||a?.company?.Id;if(t)return d=t,inf("companyId:fromProfile",{companyId:d}),d}catch(e){dbg("companyId:error",e)}return null}async function fetchHours(){try{const e=`/locations/${n}/hours`;inf("load:GET",{url:e});const a=await(window.SecureApiService?.get(e)||{});dbg("load:resp",a);const t=extractList(a);if(inf("load:extracted",{count:t.length}),t.length>0||a?.success)return u=e,t}catch(e){dbg("load:primary:error",e)}try{const e=await resolveCompanyId();if(!e)return[];const a=`/companies/${e}/locations/${n}/hours`;inf("load:GET:fallback",{url:a});const t=await(window.SecureApiService?.get(a)||{});dbg("load:resp:fallback",t);const r=extractList(t);if(inf("load:extracted:fallback",{count:r.length}),r.length>0||t?.success)return u=a,r}catch(e){dbg("load:fallback:error",e)}return[]}function mapBackendHour(e){if(!e)return null;let a=0;if("number"==typeof e.DayOfWeek)a=e.DayOfWeek;else if("string"==typeof e.DayOfWeek){const t=parseInt(e.DayOfWeek,10);if(isNaN(t)){const t=i.find(a=>a.label.toLowerCase()===e.DayOfWeek.toLowerCase());a=t?t.value:0}else a=t}else"number"==typeof e.day&&(a=e.day);a>=1&&a<=7&&(a%=7),(a<0||a>6)&&(a=0);const t=!(!e.IsClosed&&!e.isClosed),n=e.OpenTime||e.open||"",r=e.CloseTime||e.close||"",o=!t&&(!0===e.Is24Hours||!0===e.is24||"00:00"===n&&("23:59"===r||"24:00"===r)),s={day:a,isOpen:!t,is24:o,open:o?"00:00":n||"09:00",close:o?"23:59":r||"22:00"};return dbg("mapBackendHour",{original:e,normalized:s}),s}f&&p&&(f.addEventListener("click",()=>{if(!g.value)return void alert("Selectează o oră.");const e=l.find(e=>e.day===g.day);e?("open"===g.field?e.open=g.value:e.close=g.value,dbg("timePicker:confirm",{day:g.day,field:g.field,value:g.value}),markDirty(),p.style.display="none",render()):p.style.display="none"}),p.querySelectorAll("[data-close]").forEach(e=>e.addEventListener("click",()=>{p.style.display="none"}))),t&&t.addEventListener("click",async()=>{if(t.disabled)return;const e=t.querySelector("span");t.disabled=!0,e&&(e.textContent="Se salvează...");try{const a=new FormData;i.forEach((e,t)=>{const n=l.find(a=>a.day===e.value)||{isOpen:!0,is24:!1,open:"09:00",close:"22:00"},r=!n.isOpen,o=!!n.is24;if(a.append(`day_${t}_closed`,String(r)),!r){const e=o?"00:00":n.open,r=o?"23:59":n.close;a.append(`day_${t}_open`,e),a.append(`day_${t}_close`,r)}});const r=function(e){const a={};for(const[t,n]of e.entries())a[t]=n;return a}(a);inf("save:payloadPreview",r);let o=await async function(e){const a=`/locations/${n}/hours`;inf("save:POST",{url:a});let t=await(window.SecureApiService?.post(a,e)||{});if(dbg("save:respPOST",t),t?.success||(dbg("save:POST failed, trying PUT"),t=await(window.SecureApiService?.put(a,e)||{}),dbg("save:respPUT",t)),t?.success)return u=a,t;const r=await resolveCompanyId();if(!r)return t;const o=`/companies/${r}/locations/${n}/hours`;return inf("save:POST:fallback",{url:o}),t=await(window.SecureApiService?.post(o,e)||{}),dbg("save:respPOST:fallback",t),t?.success||(dbg("save:POST fallback failed, trying PUT"),t=await(window.SecureApiService?.put(o,e)||{}),dbg("save:respPUT:fallback",t)),t?.success&&(u=o),t}(a),{success:s,error:d,data:p}=o||{};if(s){try{const e=Array.isArray(p)?p:p&&Array.isArray(p.items)?p.items:[];if(dbg("save:respDataExtracted",{count:Array.isArray(e)?e.length:0}),e&&e.length){const a=e.map(mapBackendHour).filter(Boolean);dbg("save:respMapped",a);l=[0,1,2,3,4,5,6].map(e=>a.find(a=>a.day===e)||l.find(a=>a.day===e)||{day:e,isOpen:!0,is24:!1,open:"09:00",close:"22:00"})}}catch(e){dbg("save:mapResponseError",e)}try{const e=await fetchHours(),a=Array.isArray(e)?e:[];if(a.length){const e=a.map(mapBackendHour).filter(Boolean);l=i.map(a=>e.find(e=>e.day===a.value)||{day:a.value,isOpen:!0,is24:!1,open:"09:00",close:"22:00"}),dbg("save:refetch:mapped",l),inf("save:refetch:mappedCount",l.length)}}catch(e){dbg("save:refetch:error",e)}c=!1,t.innerHTML='<i class="fas fa-check"></i> <span>Program Salvat</span>',setTimeout(()=>{t.innerHTML='<i class="fas fa-save"></i> <span>Salvează Program</span>',t.disabled=!0},1400)}else console.error("Save hours error:",d),dbg("save:error",d),alert("Eroare: salvarea programului a eșuat"),t.disabled=!1,e&&(e.textContent="Salvează Program")}catch(e){console.error("Error saving hours:",e),dbg("save:exception",e),alert("Eroare: salvarea programului a eșuat"),t.disabled=!1;const a=t.querySelector("span");a&&(a.textContent="Salvează Program")}}),async function(){try{a&&(a.innerHTML='<div style="display:flex;justify-content:center;padding:28px 0;color:#64748b;">\n          <i class="fas fa-spinner fa-spin" style="margin-right:8px;"></i>Se încarcă programul...\n        </div>');const e=await fetchHours();dbg("load:extracted",e),inf("load:listCount",{count:e.length,endpoint:u});const t=e.map(mapBackendHour).filter(Boolean);dbg("load:mapped",t),inf("load:mappedCount",t.length),l=i.map(e=>t.find(a=>a.day===e.value)||{day:e.value,isOpen:!0,is24:!1,open:"09:00",close:"22:00"})}catch(e){console.warn("Failed to load hours, using defaults",e),dbg("load:errorDefaults",e),l=i.map(e=>({day:e.value,isOpen:!0,is24:!1,open:"09:00",close:"22:00"}))}finally{c=!1,t&&(t.disabled=!0),render()}}(),window.hoursDebug={get hours(){return l},get endpoint(){return u},render:render,markDirty:markDirty,company:async()=>await resolveCompanyId(),dumpStorages(){try{const e={};for(let a=0;a<sessionStorage.length;a++){const t=sessionStorage.key(a);t&&(e[t]=sessionStorage.getItem(t))}const a={};for(let e=0;e<localStorage.length;e++){const t=localStorage.key(e);t&&(a[t]=localStorage.getItem(t))}return{sessionStorage:e,localStorage:a}}catch{return{}}},async refetch(){try{dbg("debug:refetch");const e=(await fetchHours()).map(mapBackendHour).filter(Boolean);l=i.map(a=>e.find(e=>e.day===a.value)||{day:a.value,isOpen:!0,is24:!1,open:"09:00",close:"22:00"}),render()}catch(e){console.error("debug:refetch error",e)}}}});