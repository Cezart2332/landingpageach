document.addEventListener("DOMContentLoaded",()=>{const e=(()=>{try{const e=localStorage.getItem("ac_debug");return null===e||("1"===e||"true"===e||"on"===e)}catch{return!0}})(),dbg=(...t)=>{e&&console.debug("[AddLocation]",...t)},t=document.getElementById("addLocationForm"),a=document.getElementById("name"),n=document.getElementById("nameError"),o=document.getElementById("address"),r=document.getElementById("phone"),i=document.getElementById("description"),l=document.getElementById("tags"),s=document.getElementById("tagsPreview"),c=document.getElementById("categories"),d=document.getElementById("reservationsToggle"),u=document.getElementById("submitBtn"),p=document.getElementById("geoStatus"),m=document.getElementById("photoArea"),g=document.getElementById("photoInput");let f,v=null,y="",h=[],b=null;const E={lat:null,lng:null,loading:!1},L=["restaurant","pub","cafenea","club"];function escapeHtml(e){return String(e).replace(/[&<>"']/g,e=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;"}[e]))}function setSubmit(e,t){u&&(u.innerHTML=e,u.disabled=!!t)}function renderTags(){s.innerHTML=h.map(e=>`<span class="tag-chip">${escapeHtml(e)}<button type="button" data-del="${escapeHtml(e)}">×</button></span>`).join(""),s.querySelectorAll("[data-del]").forEach(e=>e.addEventListener("click",()=>{h=h.filter(t=>t!==e.dataset.del),renderTags(),validate()}))}function handlePhoto(){const e=g.files&&g.files[0];if(!e)return;b=e;const t=URL.createObjectURL(e);m.innerHTML=`<img src="${t}" class="photo-preview" alt="preview"/><button type="button" class="remove-photo" id="removePhoto">Elimină fotografia</button>`;const a=document.getElementById("removePhoto");a&&a.addEventListener("click",()=>{b=null,g.value="",m.innerHTML='<i class="fas fa-camera" style="font-size:2rem;color:#a855f7;"></i><p style="margin:10px 0 4px;font-weight:600;color:#a855f7;">Adaugă o fotografie</p><p style="margin:0;color:#64748b;font-size:.7rem;">Click sau trage o imagine (16:9 recomandat)</p><input type="file" id="photoInput" accept="image/*" style="display:none;" />',document.getElementById("photoInput").addEventListener("change",handlePhoto)})}function updateGeoStatus(){p&&(E.loading?p.innerHTML='<div class="geo-status geo-loading"><i class="fas fa-hourglass-half"></i> Obțin coordonate...</div>':E.lat&&E.lng?p.innerHTML=`<div class="geo-status geo-ok"><i class="fas fa-check-circle"></i> Localizat: ${E.lat}, ${E.lng}</div>`:o.value.trim().length>=5?p.innerHTML='<div class="geo-status geo-loading" style="background:rgba(239,68,68,.1);border-color:rgba(239,68,68,.4);color:#ef4444;"><i class="fas fa-triangle-exclamation"></i> Nu s-au putut obține coordonatele</div>':p.innerHTML="")}function validate(){let e=!0;return a.value.trim()?(a.classList.remove("error"),n.style.display="none"):(a.classList.add("error"),n.style.display="block",n.textContent="Introdu numele locației.",e=!1),o.value.trim()&&E.lat&&E.lng||(e=!1),r.value.trim()||(e=!1),y||(e=!1),u&&(u.disabled=!e),e}async function safeProfile(){try{const e=await window.SecureApiService.getProfile();return dbg("getProfile:resp",e),e&&"object"==typeof e&&"success"in e&&"data"in e?e.data:e}catch(e){return dbg("getProfile:error",e),null}}function extractCompanyId(e){if(!e)return null;const t=e.id||e.Id||e.companyId||e.CompanyId||e.company&&(e.company.id||e.company.Id)||null;return dbg("extractCompanyId",{profile:e,cid:t}),t}c&&(c.innerHTML=L.map(e=>`<button type="button" class="cat-pill" data-cat="${e}">${e}</button>`).join(""),c.querySelectorAll(".cat-pill").forEach(e=>{e.addEventListener("click",()=>{y=e.dataset.cat,c.querySelectorAll(".cat-pill").forEach(t=>t.classList.toggle("active",t===e)),validate()})})),l&&(l.addEventListener("input",()=>{const e=l.value;e.includes(",")&&(e.split(",").map(e=>e.trim()).filter(Boolean).forEach(e=>{!h.includes(e)&&h.length<50&&h.push(e)}),l.value="",renderTags(),validate())}),l.addEventListener("keydown",e=>{if("Enter"===e.key){e.preventDefault();const t=l.value.trim();t&&(h.includes(t)||h.push(t),l.value="",renderTags(),validate())}"Backspace"!==e.key||l.value||(h.pop(),renderTags(),validate())})),m&&m.addEventListener("click",()=>g.click()),g&&g.addEventListener("change",handlePhoto),m&&(m.addEventListener("dragover",e=>{e.preventDefault(),m.style.borderColor="#a855f7"}),m.addEventListener("dragleave",()=>m.style.borderColor="rgba(139,92,246,.3)"),m.addEventListener("drop",e=>{e.preventDefault(),m.style.borderColor="rgba(139,92,246,.3)",e.dataTransfer.files[0]&&(g.files=e.dataTransfer.files,handlePhoto())})),o&&o.addEventListener("input",()=>{f&&clearTimeout(f);const e=o.value.trim();if(e.length<5)return E.lat=null,E.lng=null,updateGeoStatus(),void validate();f=setTimeout(()=>{return t=e,E.loading=!0,updateGeoStatus(),void fetch(`https://api.geoapify.com/v1/geocode/search?text=${encodeURIComponent(t+", Romania")}&limit=1&lang=ro&filter=countrycode:ro&apiKey=d5466dbfa4a84344b872af4009106e17`).then(e=>e.json()).then(e=>{const t=e.features&&e.features[0];if(t){const[e,a]=t.geometry.coordinates;E.lat=Number(a).toFixed(6),E.lng=Number(e).toFixed(6)}else E.lat=null,E.lng=null}).catch(()=>{E.lat=null,E.lng=null}).finally(()=>{E.loading=!1,updateGeoStatus(),validate()});var t},650)}),["input","blur"].forEach(e=>a.addEventListener(e,validate)),r&&r.addEventListener("input",validate),i&&i.addEventListener("input",validate),t&&t.addEventListener("submit",async e=>{if(e.preventDefault(),validate()){setSubmit('<i class="fas fa-spinner fa-spin"></i> Creare...',!0);try{try{const e={};for(let t=0;t<sessionStorage.length;t++){const a=sessionStorage.key(t);a&&(e[a]=sessionStorage.getItem(a))}const t={};for(let e=0;e<localStorage.length;e++){const a=localStorage.key(e);a&&(t[a]=localStorage.getItem(a))}dbg("storageSnapshot",{sessionStorage:e,localStorage:t})}catch{}if(!v){const e=await safeProfile();v=extractCompanyId(e)}if(!v)throw new Error("Nu s-a putut identifica compania.");const e=a.value.trim(),t=await async function(e,t){try{const a=await window.SecureApiService.get(`/companies/${e}/locations`);return(a&&a.success&&Array.isArray(a.data)?a.data:Array.isArray(a)?a:[]).some(e=>(e.name||e.Name||"").toLowerCase()===t.toLowerCase())}catch(e){return console.warn("Name check failed:",e),!1}}(v,e);if(t)return n.style.display="block",n.textContent="O locație cu acest nume există deja. Alege un nume diferit.",alert("Nume Locație Duplicat: O locație cu acest nume există deja pentru compania ta."),void setSubmit('<i class="fas fa-plus-circle"></i> Creează Locație',!1);const l=Number(E.lat),s=Number(E.lng);if(!Number.isFinite(l)||!Number.isFinite(s))return alert("Coordonatele nu sunt valide. Reintrodu adresa."),void setSubmit('<i class="fas fa-plus-circle"></i> Creează Locație',!1);const c=new FormData;c.append("name",e),c.append("address",o.value.trim()),c.append("category",y),c.append("phoneNumber",r.value.trim()),c.append("latitude",l.toFixed(6)),c.append("longitude",s.toFixed(6)),c.append("tags",h.join(", ")),c.append("description",i.value||""),c.append("reservationsEnabled",d.checked?"true":"false"),b&&c.append("photo",b,b.name||"location_photo.jpg");const u=await window.SecureApiService.post(`/companies/${v}/locations`,c);if(u&&u.success)return alert("Locația a fost adăugată cu succes!"),void(window.location.href="business-locations.html");let p="Adăugarea locației a eșuat";if(u&&u.error&&(p=u.error?.detail||u.error?.Error||u.error?.message||p,409===u.status))return alert("Nume Locație Duplicat: "+p),void setSubmit('<i class="fas fa-plus-circle"></i> Creează Locație',!1);alert(p),setSubmit('<i class="fas fa-plus-circle"></i> Creează Locație',!1)}catch(e){console.error("Create location error:",e),dbg("submit:error",e),alert("Eroare: adăugarea locației a eșuat"),setSubmit('<i class="fas fa-plus-circle"></i> Creează Locație',!1)}}}),async function(){try{try{const e=sessionStorage.getItem("company"),t=localStorage.getItem("company"),a=e||t;if(a)try{const e=JSON.parse(a),t=e?.id||e?.Id;t&&(v=t),dbg("initCompany:fromStorage",{cid:t})}catch{}}catch{}if(!v){const e=await safeProfile();v=extractCompanyId(e)}dbg("initCompany:resolved",{companyId:v})}catch{}}(),validate()});