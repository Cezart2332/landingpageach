document.addEventListener("DOMContentLoaded",()=>{document.body.classList.add("loading");const e=["localhost","127.0.0.1"].includes(window.location.hostname)?"/api":"https://api.acoomh.ro";let t=[],n=[],a=[],i="all",o="",s="all",r=null,c=[];const d={statsRow:document.getElementById("statsRow"),filterTabs:document.getElementById("filterTabs"),searchInput:document.getElementById("searchInput"),locationFilter:document.getElementById("locationFilter"),eventsGrid:document.getElementById("eventsGrid"),loadingState:document.getElementById("loadingState"),errorState:document.getElementById("errorState"),emptyState:document.getElementById("emptyState"),eventModal:document.getElementById("eventModal"),eventForm:document.getElementById("eventForm"),modalTitle:document.getElementById("modalTitle"),deleteModal:document.getElementById("deleteModal"),deleteEventName:document.getElementById("deleteEventName"),eventName:document.getElementById("eventName"),eventDescription:document.getElementById("eventDescription"),eventDate:document.getElementById("eventDate"),eventTime:document.getElementById("eventTime"),eventEndTime:document.getElementById("eventEndTime"),eventAddress:document.getElementById("eventAddress"),eventCity:document.getElementById("eventCity"),isActive:document.getElementById("isActive"),eventImage:document.getElementById("eventImage"),imageUploadArea:document.getElementById("imageUploadArea"),imagePreview:document.getElementById("imagePreview"),previewImg:document.getElementById("previewImg"),removeImage:document.getElementById("removeImage"),eventTags:document.getElementById("eventTags"),tagsPreview:document.getElementById("tagsPreview"),ownLocationRadio:document.getElementById("ownLocationRadio")||document.getElementById("ownLocation"),otherLocationRadio:document.getElementById("otherLocationRadio")||document.getElementById("otherLocation"),ownLocationSelector:document.getElementById("ownLocationSelector"),otherLocationInput:document.getElementById("otherLocationInput"),customLocationName:document.getElementById("customLocationName"),customLocationAddress:document.getElementById("customLocationAddress")};function unwrapList(e){return e?Array.isArray(e)?e:Array.isArray(e?.data)?e.data:Array.isArray(e?.items)?e.items:Array.isArray(e?.events)?e.events:[]:[]}async function getActiveCompanyId(){try{if(window.SecureApiService){const e=await window.SecureApiService.getProfile(),t=e&&e.success?e.data:e,n=t?.company||t,a=n?.id||n?.Id;if(a)return Number(a)}}catch(e){}try{const e=sessionStorage.getItem("company");if(e){const t=JSON.parse(e);if(t?.id||t?.Id)return Number(t.id||t.Id)}const t=sessionStorage.getItem("user");if(t){const e=JSON.parse(t);if(e?.id||e?.Id)return Number(e.id||e.Id)}}catch(e){console.warn("Failed to read company/user from storage:",e)}return null}async function loadBusinessEvents(){d.loadingState.style.display="flex",d.errorState.style.display="none",d.emptyState.style.display="none",d.eventsGrid.style.display="none";try{const a=await getActiveCompanyId();if(a&&window.SecureApiService){const e=new FormData;e.append("id",String(a)),e.append("companyId",String(a));const i=await window.SecureApiService.post("/companyevents",e);let o=i&&i.success?i.data:i;if(o=unwrapList(o),Array.isArray(o)&&0!==o.length)t=o.map(normalizeEvent),n=[...t];else{const e=await window.SecureApiService.get("/events");let i=e&&e.success?e.data:e;i=unwrapList(i);const o=i.filter(e=>Number(e.companyId||e.CompanyId||e.company?.id)===Number(a));t=o.map(normalizeEvent),n=[...t]}return updateStatistics(),displayEvents(),hideLoadingState(),void console.log("✅ Loaded business events:",n.length)}const i=await fetch(`${e}/events`,{method:"GET",headers:{"Content-Type":"application/json",Accept:"application/json"}});if(!i.ok)throw new Error(`HTTP error! status: ${i.status}`);const o=await i.json(),s=o.data||o||[];if(!Array.isArray(s))throw new Error("API response is not a valid events array");t=s.map(normalizeEvent),n=[...t],updateStatistics(),displayEvents(),hideLoadingState()}catch(e){console.error("Error loading business events:",e),t=Array.isArray(t)?t:[],n=t,displayEvents(),hideLoadingState()}}function hideLoadingState(){d.loadingState.style.display="none"}function displayEvents(){const e=getFilteredEvents();if(0===e.length)return d.loadingState.style.display="none",d.errorState.style.display="none",d.emptyState.style.display="flex",void(d.eventsGrid.style.display="none");d.loadingState.style.display="none",d.errorState.style.display="none",d.emptyState.style.display="none",d.eventsGrid.style.display="grid",d.eventsGrid.innerHTML="",e.forEach(e=>{const t=function(e){const t=document.createElement("div");t.className="event-card",t.setAttribute("data-event-id",e.id);const n=(s=e.status,{upcoming:"status-upcoming",active:"status-active",past:"status-past",draft:"status-draft"}[s]||"status-upcoming"),a=function(e){return{upcoming:"Viitor",active:"Activ",past:"Trecut",draft:"Draft"}[e]||"Viitor"}(e.status),i=function(e,t){try{const n=new Date(e+"T"+t),a={year:"numeric",month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"};return n.toLocaleDateString("ro-RO",a)}catch(n){return`${e} la ${t}`}}(e.eventDate,e.eventTime),o=e.tags||[];var s;return t.innerHTML=`\n      <div class="event-image">\n        <img src="${e.imageUrl||function(e){return`https://picsum.photos/seed/${e||"event"}/400/300`}(e.category)}" alt="${e.name}" loading="lazy" />\n        <div class="event-status-badge ${n}">${a}</div>\n      </div>\n      <div class="event-content">\n        <div class="event-header">\n          <h3 class="event-name">${e.name}</h3>\n          <div class="event-location">\n            <i class="fas fa-location-dot"></i>\n            <span>${e.locationName||"Locație necunoscută"}</span>\n          </div>\n          <div class="event-date">\n            <i class="fas fa-calendar"></i>\n            <span>${i}</span>\n          </div>\n        </div>\n        \n        ${o.length>0?`\n          <div class="event-tags">\n            ${o.slice(0,3).map(e=>`<span class="event-tag">${e}</span>`).join("")}\n            ${o.length>3?`<span class="event-tag">+${o.length-3}</span>`:""}\n          </div>\n        `:""}\n        \n        <div class="event-stats">\n          <div class="event-stat">\n            <i class="fas fa-users"></i>\n            <span>${e.capacity||"N/A"} max</span>\n          </div>\n          <div class="event-stat">\n            <i class="fas fa-ticket-alt"></i>\n            <span>${e.ticketsSold||0} vândute</span>\n          </div>\n          <div class="event-stat">\n            <i class="fas fa-euro-sign"></i>\n            <span>${e.isPaid?e.ticketPrice+" RON":"Gratuit"}</span>\n          </div>\n        </div>\n        \n        <div class="event-actions">\n          <button class="btn-view" onclick="viewEventDetails('${e.id}')">\n            <i class="fas fa-eye"></i> Vezi\n          </button>\n          <button class="btn-icon edit" onclick="editEvent('${e.id}')" title="Editează">\n            <i class="fas fa-pen"></i>\n          </button>\n          <button class="btn-icon delete" onclick="confirmDeleteEvent('${e.id}')" title="Șterge">\n            <i class="fas fa-trash"></i>\n          </button>\n        </div>\n      </div>\n    `,t}(e);d.eventsGrid.appendChild(t)})}function normalizeEvent(e){if(!e||"object"!=typeof e)return{};const t=e.id||e.Id||e.eventId||e.EventId||e._id||String(Math.random()).slice(2),n=e.name||e.Name||e.title||"Eveniment",a=e.description||e.Description||"",i=(e.category||e.Category||"altele").toString().toLowerCase(),o=e.locationId||e.LocationId||e.location?.id||e.Location?.Id||null,s=e.locationName||e.LocationName||e.location?.name||e.Location?.Name||e.Location||"Locație necunoscută",r=e.eventDate||e.EventDate||e.date||e.Date||"",c=e.eventTime||e.EventTime||e.time||e.Time||e.startTime||e.StartTime||"",d="string"==typeof r&&r.includes("-")?r:r?new Date(r).toISOString().slice(0,10):"",l="string"==typeof c&&c.includes(":")?c:c?String(c).padStart(4,"0").replace(/(\d{2})(\d{2})/,"$1:$2"):"",u=e.duration||e.Duration||"",m=e.capacity||e.Capacity||"",v=!!(e.isPaid||e.IsPaid||e.hasPaidTickets||e.HasPaidTickets),p=e.ticketPrice||e.Price||e.price||0,g=e.earlyBirdPrice||e.EarlyBirdPrice||null,y=e.earlyBirdDeadline||e.EarlyBirdDeadline||null;let f=[];Array.isArray(e.tags)?f=e.tags.map(e=>String(e)):"string"==typeof e.tags&&(f=e.tags.split(",").map(e=>e.trim()).filter(Boolean));const E=e.specialInstructions||"",w=!(!e.isPromoted&&!e.IsPromoted),h=e.ticketsSold||e.TicketsSold||0,I=e.imageUrl||e.photoUrl||e.PhotoUrl||e.photo||e.Photo||"",S=e.status||function(e,t){const n=new Date,a=new Date(e+"T"+t);return a>n?"upcoming":a.toDateString()===n.toDateString()?"active":"past"}(d||"",l||"");return{id:t,name:n,description:a,category:i,locationId:o,locationName:s,eventDate:d,eventTime:l,duration:u,capacity:m,isPaid:v,ticketPrice:p,earlyBirdPrice:g,earlyBirdDeadline:y,tags:f,specialInstructions:E,isPromoted:w,ticketsSold:h,imageUrl:I,status:S}}function getFilteredEvents(){let e=[...t];if("all"!==i&&(e=e.filter(e=>e.status===i)),"all"!==s&&(e=e.filter(e=>e.locationId.toString()===s)),o){const t=o.toLowerCase();e=e.filter(e=>e.name.toLowerCase().includes(t)||e.description.toLowerCase().includes(t)||e.category.toLowerCase().includes(t)||e.tags&&e.tags.some(e=>e.toLowerCase().includes(t)))}return e}function updateStatistics(){const e={total:t.length,active:t.filter(e=>"active"===e.status).length,upcoming:t.filter(e=>"upcoming"===e.status).length,ticketsSold:t.reduce((e,t)=>e+(t.ticketsSold||0),0)};document.getElementById("totalEvents").textContent=e.total,document.getElementById("activeEvents").textContent=e.active,document.getElementById("upcomingEvents").textContent=e.upcoming,document.getElementById("ticketsSold").textContent=e.ticketsSold}function populateLocationFilter(){const e=d.locationFilter;e.innerHTML='<option value="all">Toate locațiile</option>',a.forEach(t=>{const n=document.createElement("option");n.value=t.id,n.textContent=t.name||t.Name||`Locația ${t.id}`,e.appendChild(n)})}function openEventModal(e=null){r=e,e?(d.modalTitle&&(d.modalTitle.textContent="Editează Eveniment"),function(e){d.eventName&&(d.eventName.value=e.title||e.name||"");d.eventDescription&&(d.eventDescription.value=e.description||"");d.eventDate&&(d.eventDate.value=e.eventDate||e.date||"");const t=(e.eventTime||e.startTime||e.time||"").toString().slice(0,5),n=(e.endTime||"").toString().slice(0,5);d.eventTime&&(d.eventTime.value=t);d.eventEndTime&&(d.eventEndTime.value=n);d.eventAddress&&(d.eventAddress.value=e.address||"");d.eventCity&&(d.eventCity.value=e.city||"");d.isActive&&(d.isActive.checked=!(!e.isActive&&"active"!==e.status));(e.imageUrl||e.photoUrl)&&d.previewImg&&d.imageUploadArea&&d.imagePreview&&(d.previewImg.src=e.imageUrl||e.photoUrl,d.imageUploadArea.style.display="none",d.imagePreview.style.display="block")}(e)):(d.modalTitle&&(d.modalTitle.textContent="Adaugă Eveniment"),resetEventForm()),d.eventModal?(d.eventModal.style.display="flex",document.body.style.overflow="hidden"):console.warn('Event modal element not found (id="eventModal")')}function closeEventModal(){d.eventModal&&(d.eventModal.style.display="none"),document.body.style.overflow="auto",resetEventForm(),r=null}function resetEventForm(){if(!d.eventForm)return;d.eventForm.reset(),d.imageUploadArea&&(d.imageUploadArea.style.display="block"),d.imagePreview&&(d.imagePreview.style.display="none"),d.previewImg&&(d.previewImg.src="");const e=(new Date).toISOString().split("T")[0];d.eventDate&&(d.eventDate.min=e)}function applyFilters(){n=getFilteredEvents(),displayEvents()}function handleLocationTypeChange(){if(!d.ownLocationRadio||!d.otherLocationRadio)return;d.ownLocationRadio.checked?(d.ownLocationSelector&&(d.ownLocationSelector.style.display="block"),d.otherLocationInput&&(d.otherLocationInput.style.display="none"),d.customLocationName&&(d.customLocationName.value=""),d.customLocationAddress&&(d.customLocationAddress.value=""),d.customLocationName&&(d.customLocationName.required=!1),d.customLocationAddress&&(d.customLocationAddress.required=!1)):(d.ownLocationSelector&&(d.ownLocationSelector.style.display="none"),d.otherLocationInput&&(d.otherLocationInput.style.display="block"),d.customLocationName&&(d.customLocationName.required=!0),d.customLocationAddress&&(d.customLocationAddress.required=!0)),function(){const e=document.getElementById("eventLocationError");e&&(e.style.display="none");const t=document.getElementById("customLocationError");t&&(t.style.display="none")}()}function handleTagsInput(e){const t=e.target.value;if(t.includes(",")){t.split(",").map(e=>e.trim()).filter(Boolean).forEach(e=>{e&&!c.includes(e)&&c.length<10&&c.push(e)}),e.target.value="",updateTagsPreview()}}function handleTagsKeydown(e){if("Enter"===e.key){e.preventDefault();const t=e.target.value.trim();t&&!c.includes(t)&&c.length<10&&(c.push(t),e.target.value="",updateTagsPreview())}"Backspace"===e.key&&!e.target.value&&c.length>0&&(c.pop(),updateTagsPreview())}function updateTagsPreview(){d.tagsPreview&&(d.tagsPreview.innerHTML=c.map(e=>`\n      <span class="tag-chip">\n        ${e}\n        <button type="button" onclick="removeTag('${e}')">×</button>\n      </span>\n    `).join(""))}function handleImageUpload(e){const t=e.target.files[0];if(t){const e=new FileReader;e.onload=e=>{!function(e){if(!d.previewImg||!d.imageUploadArea||!d.imagePreview)return;d.previewImg.src=e,d.imageUploadArea.style.display="none",d.imagePreview.style.display="block"}(e.target.result)},e.readAsDataURL(t)}}function hideImagePreview(){d.imageUploadArea&&d.imagePreview&&(d.imageUploadArea.style.display="block",d.imagePreview.style.display="none",d.eventImage&&(d.eventImage.value=""))}async function handleEventFormSubmit(n){if(n.preventDefault(),console.log("Form submission started..."),!function(){clearFormErrors();const e=[];return d.eventName.value.trim()||(showFieldError("eventNameError","Titlul este obligatoriu"),e.push("name")),d.eventDescription.value.trim()||(showFieldError("eventDescriptionError","Descrierea este obligatorie"),e.push("desc")),d.eventDate.value||(showFieldError("eventDateError","Data este obligatorie"),e.push("date")),d.eventTime.value||(showFieldError("eventTimeError","Ora de început este obligatorie"),e.push("stime")),d.eventEndTime.value||(showFieldError("eventEndTimeError","Ora de sfârșit este obligatorie"),e.push("etime")),d.eventAddress.value.trim()||(showFieldError("eventAddressError","Adresa este obligatorie"),e.push("addr")),0===e.length}())return void console.log("Form validation failed");const a=document.getElementById("saveEventBtn"),i=a?a.innerHTML:"";try{a&&(a.disabled=!0,a.innerHTML='<i class="fas fa-spinner fa-spin"></i> Salvare...');const n=await async function(){try{if(window.SecureApiService){const e=await window.SecureApiService.getProfile(),t=e&&e.success?e.data:e,n=t?.company||t;return n?.id||n?.Id||null}}catch{}try{const e=sessionStorage.getItem("company");if(e){const t=JSON.parse(e);return t?.id||t?.Id||null}}catch{}return null}(),i={title:d.eventName?.value.trim(),description:d.eventDescription?.value.trim(),eventDate:d.eventDate?.value,startTime:5===d.eventTime?.value?.length?d.eventTime.value+":00":d.eventTime?.value,endTime:5===d.eventEndTime?.value?.length?d.eventEndTime.value+":00":d.eventEndTime?.value,address:d.eventAddress?.value.trim(),city:d.eventCity?.value.trim(),isActive:!!d.isActive?.checked,companyId:n,imageFile:d.eventImage?.files?.[0]||null};let o;if(r){console.log("Updating existing event:",r.id),o=await async function(t,n){try{const a=new FormData;if(a.append("title",n.title),a.append("description",n.description),a.append("eventDate",n.eventDate),a.append("startTime",n.startTime),a.append("endTime",n.endTime),a.append("address",n.address),n.city&&a.append("city",n.city),"boolean"==typeof n.isActive&&a.append("isActive",n.isActive?"true":"false"),n.imageFile&&a.append("file",n.imageFile),window.SecureApiService){const e=await window.SecureApiService.put(`/events/${t}`,a);if(!e||!e.success)throw new Error(e?.error||"Failed to update event");const n=e.data||null;return console.log("✅ Successfully updated event:",n),n}const i=await fetch(`${e}/events/${t}`,{method:"PUT",body:a});if(!i.ok){const e=await i.text();throw new Error(e||"Failed to update event")}const o=await i.json();return console.log("✅ Successfully updated event (fallback):",o),o}catch(e){throw console.error("Error updating event:",e),e}}(r.id,i);const n=t.findIndex(e=>e.id.toString()===String(r.id));if(-1!==n){const e=normalizeEvent({...t[n],...i,...o});t[n]=e}showNotification("Eveniment actualizat cu succes!","success")}else{console.log("Creating new event"),o=await async function(t){try{const n=new FormData;if(n.append("title",t.title),n.append("description",t.description),n.append("eventDate",t.eventDate),n.append("startTime",t.startTime),n.append("endTime",t.endTime),n.append("address",t.address),t.city&&n.append("city",t.city),t.companyId&&n.append("companyId",String(t.companyId)),n.append("isActive",t.isActive?"true":"false"),t.imageFile&&n.append("file",t.imageFile),window.SecureApiService){const e=await window.SecureApiService.post("/events",n);if(!e||!e.success)throw new Error(e?.error||"Failed to create event");const t=e.data||null;return console.log("✅ Successfully created event:",t),t}const a=await fetch(`${e}/events`,{method:"POST",body:n});if(!a.ok){const e=await a.text();throw new Error(e||"Failed to create event")}const i=await a.json();return console.log("✅ Successfully created event (fallback):",i),i}catch(e){throw console.error("Error creating event:",e),e}}(i);const n=normalizeEvent({...i,...o});n.id||(n.id=o?.id||Date.now()),n.locationName||(n.locationName=i.address),t.unshift(n),showNotification("Eveniment creat cu succes!","success")}closeEventModal(),updateStatistics(),applyFilters()}catch(e){console.error("Error saving event:",e),showNotification("Eroare la salvarea evenimentului: "+(e?.message||"Unknown error"),"error")}finally{a&&(a.disabled=!1,a.innerHTML=i)}}function closeDeleteModal(){d.deleteModal.style.display="none",document.body.style.overflow="auto",delete d.deleteModal.dataset.eventId}async function handleDeleteEvent(){const n=d.deleteModal.dataset.eventId;if(!n)return;const a=document.getElementById("confirmDeleteBtn"),i=a.innerHTML;try{a.disabled=!0,a.innerHTML='<i class="fas fa-spinner fa-spin"></i> Ștergere...',await async function(t){try{if(window.SecureApiService){const e=await window.SecureApiService.delete(`/events/${t}`);if(!e||!e.success)throw new Error(e?.error||`HTTP ${e?.status}`);return console.log("✅ Successfully deleted event:",t),!0}const n=await fetch(`${e}/events/${t}`,{method:"DELETE",headers:{"Content-Type":"application/json"}});if(!n.ok)throw new Error(`HTTP error! status: ${n.status}`);return console.log("✅ Successfully deleted event (fallback):",t),!0}catch(e){throw console.error("Error deleting event:",e),e}}(n),t=t.filter(e=>e.id.toString()!==n.toString()),closeDeleteModal(),updateStatistics(),applyFilters(),showNotification("Eveniment șters cu succes!","success")}catch(e){console.error("Error deleting event:",e),showNotification("Eroare la ștergerea evenimentului: "+e.message,"error")}finally{a.disabled=!1,a.innerHTML=i}}function showNotification(e,t="info"){const n=document.createElement("div");if(n.className=`notification ${t}`,n.innerHTML=`\n      <div class="notification-content">\n        <i class="fas ${"success"===t?"fa-check-circle":"error"===t?"fa-exclamation-circle":"fa-info-circle"}"></i>\n        <span>${e}</span>\n      </div>\n    `,!document.querySelector(".notification-styles")){const e=document.createElement("style");e.className="notification-styles",e.textContent="\n        .notification {\n          position: fixed;\n          top: 80px;\n          right: 20px;\n          z-index: 10000;\n          padding: 16px 20px;\n          border-radius: 12px;\n          color: #fff;\n          font-weight: 600;\n          box-shadow: 0 10px 25px rgba(0,0,0,0.3);\n          animation: slideInRight 0.3s ease;\n        }\n        .notification.success { background: var(--success); }\n        .notification.error { background: var(--danger); }\n        .notification.info { background: var(--info); }\n        .notification-content { display: flex; align-items: center; gap: 10px; }\n        @keyframes slideInRight {\n          from { transform: translateX(100%); opacity: 0; }\n          to { transform: translateX(0); opacity: 1; }\n        }\n      ",document.head.appendChild(e)}document.body.appendChild(n),setTimeout(()=>{n.style.animation="slideInRight 0.3s ease reverse",setTimeout(()=>n.remove(),300)},3e3)}function hideLoadingOverlay(){const e=document.getElementById("pageLoadingOverlay")||document.getElementById("immediateLoadingOverlay");e&&(e.classList.add("hidden"),setTimeout(()=>{document.body.classList.add("loaded"),document.body.classList.remove("loading")},300))}window.viewEventDetails=function(e){window.open(`event.html?id=${e}`,"_blank")},window.editEvent=function(e){const n=t.find(t=>t.id.toString()===e.toString());n?openEventModal(n):console.warn("Event not found for edit:",e)},window.confirmDeleteEvent=function(e){!function(e){const n=t.find(t=>t.id.toString()===e.toString());n&&(d.deleteEventName.textContent=n.name,d.deleteModal.style.display="flex",d.deleteModal.dataset.eventId=e,document.body.style.overflow="hidden")}(e)},window.removeTag=function(e){c=c.filter(t=>t!==e),updateTagsPreview()},async function(){try{!function(){document.querySelectorAll("[data-logout]").forEach(e=>{e.addEventListener("click",()=>{confirm("Sigur te deconectezi?")&&(window.location.href="business-auth.html")})});const e=document.getElementById("addEventBtn");e&&e.addEventListener("click",()=>openEventModal());const t=document.getElementById("addFirstEventBtn");t&&t.addEventListener("click",()=>openEventModal());d.filterTabs&&d.filterTabs.addEventListener("click",e=>{const t=e.target.closest(".filter-btn");t&&(i=t.dataset.filter,function(){if(!d.filterTabs)return;d.filterTabs.querySelectorAll(".filter-btn").forEach(e=>{e.classList.toggle("active",e.dataset.filter===i)})}(),applyFilters())});d.searchInput&&d.searchInput.addEventListener("input",e=>{o=e.target.value.trim(),applyFilters()});d.locationFilter&&d.locationFilter.addEventListener("change",e=>{s=e.target.value,applyFilters()});document.querySelectorAll("[data-close-modal]").forEach(e=>{e.addEventListener("click",closeEventModal)}),document.querySelectorAll("[data-close-delete]").forEach(e=>{e.addEventListener("click",closeDeleteModal)}),d.eventForm&&d.eventForm.addEventListener("submit",handleEventFormSubmit);d.eventTags&&(d.eventTags.addEventListener("input",handleTagsInput),d.eventTags.addEventListener("keydown",handleTagsKeydown));d.imageUploadArea&&d.eventImage&&d.imageUploadArea.addEventListener("click",()=>d.eventImage.click());d.eventImage&&d.eventImage.addEventListener("change",handleImageUpload);d.removeImage&&d.removeImage.addEventListener("click",hideImagePreview);const n=document.getElementById("confirmDeleteBtn");n&&n.addEventListener("click",handleDeleteEvent);const a=document.getElementById("retryBtn");a&&a.addEventListener("click",()=>{loadBusinessEvents()});d.ownLocationRadio&&d.ownLocationRadio.addEventListener("change",handleLocationTypeChange);d.otherLocationRadio&&d.otherLocationRadio.addEventListener("change",handleLocationTypeChange)}(),await async function(){try{const t=await getActiveCompanyId();if(t&&window.SecureApiService){const e=await window.SecureApiService.get(`/companies/${t}/locations`),n=e&&e.success?e.data:e;return a=Array.isArray(n)?n:[],populateLocationFilter(),void console.log("✅ Loaded company locations:",a.length)}const n=await fetch(`${e}/locations`,{method:"GET",headers:{"Content-Type":"application/json",Accept:"application/json"}});if(n.ok){const e=await n.json();a=Array.isArray(e)?e:e.data||[],populateLocationFilter(),console.log("✅ Loaded user locations (fallback):",a.length)}else console.warn("Could not load user locations, using fallback mock data"),a=[{id:1,name:"Central Bistro",address:"Str. Centrală Nr. 15, București"},{id:2,name:"Urban Roast",address:"Bd. Magheru Nr. 28, București"},{id:3,name:"Garden Lounge",address:"Str. Florilor Nr. 42, București"}],populateLocationFilter()}catch(e){console.error("Error loading user locations:",e),console.warn("Using fallback mock locations for demonstration"),a=[{id:1,name:"Central Bistro",address:"Str. Centrală Nr. 15, București"},{id:2,name:"Urban Roast",address:"Bd. Magheru Nr. 28, București"},{id:3,name:"Garden Lounge",address:"Str. Florilor Nr. 42, București"}],populateLocationFilter()}}(),await loadBusinessEvents(),updateStatistics(),hideLoadingOverlay()}catch(e){console.error("Error initializing business events page:",e),t="Nu s-au putut încărca datele. Încearcă din nou.",d.loadingState.style.display="none",d.errorState.style.display="flex",d.emptyState.style.display="none",d.eventsGrid.style.display="none",document.getElementById("errorMessage").textContent=t,hideLoadingOverlay()}var t}()});