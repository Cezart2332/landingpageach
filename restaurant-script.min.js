const API_BASE_URL="localhost"===window.location.hostname||"127.0.0.1"===window.location.hostname||""===window.location.hostname?"https://cors-anywhere.herokuapp.com/https://api.acoomh.ro":"https://api.acoomh.ro";let currentLocation=null;async function loadLocationDetails(e){try{showLoadingState();const t={"Content-Type":"application/json",Accept:"application/json"};"localhost"!==window.location.hostname&&"127.0.0.1"!==window.location.hostname&&""!==window.location.hostname||(t["X-Requested-With"]="XMLHttpRequest");const a=await fetch(`${API_BASE_URL}/locations/${e}`,{method:"GET",headers:t});if(!a.ok){if(404===a.status)throw new Error("Locația nu a fost găsită.");throw new Error(`HTTP error! status: ${a.status}`)}const n=await a.json();currentLocation=n,await loadLocationHours(e),populateLocationDetails(n),hideLoadingState(),console.log("✅ Successfully loaded location details:",n)}catch(e){console.error("Error loading location details:",e),showError(e.message||"Nu am putut încărca detaliile locației.")}}async function loadLocationHours(e){try{const t={"Content-Type":"application/json",Accept:"application/json"};"localhost"!==window.location.hostname&&"127.0.0.1"!==window.location.hostname&&""!==window.location.hostname||(t["X-Requested-With"]="XMLHttpRequest");const a=await fetch(`${API_BASE_URL}/locations/${e}/hours`,{method:"GET",headers:t});if(a.ok){const e=await a.json();currentLocation.hours=e}}catch(e){console.log("Could not load location hours:",e)}}async function createReservation(e){try{const t={"Content-Type":"application/json",Accept:"application/json"};"localhost"!==window.location.hostname&&"127.0.0.1"!==window.location.hostname&&""!==window.location.hostname||(t["X-Requested-With"]="XMLHttpRequest");const a=await fetch(`${API_BASE_URL}/reservations`,{method:"POST",headers:t,body:JSON.stringify(e)});if(!a.ok){const e=await a.json().catch(()=>({}));throw new Error(e.message||`HTTP error! status: ${a.status}`)}const n=await a.json();return console.log("✅ Successfully created reservation:",n),n}catch(e){throw console.error("Error creating reservation:",e),e}}function getLocationId(){return new URLSearchParams(window.location.search).get("id")}function showLoadingState(){document.body.classList.add("loading")}function hideLoadingState(){document.body.classList.remove("loading")}function showError(e){showPopup("Eroare",e,"fas fa-exclamation-triangle")}function populateLocationDetails(e){document.getElementById("restaurantName").textContent=e.name||"Restaurant",document.getElementById("restaurantAddress").textContent=e.address||"Adresă necunoscută",document.getElementById("restaurantCuisine").textContent=e.category||"Restaurant";const t=e.description||`Descoperă ${e.name||"acest loc"}, un loc minunat cu o atmosferă unică și o experiență de neuitat. Situat în ${e.address||"oraș"}, oferim servicii de calitate și o experiență plăcută pentru toți vizitatorii.`;document.getElementById("restaurantDescription").textContent=t;const a=document.getElementById("restaurantImage");if(e.photo&&Array.isArray(e.photo)&&e.photo.length>0)try{const t=`data:image/jpeg;base64,${btoa(String.fromCharCode.apply(null,e.photo))}`;a.src=t,a.onerror=()=>setDefaultImage(a,e.category)}catch(t){console.error("Error processing image:",t),setDefaultImage(a,e.category)}else if(e.photo&&"string"==typeof e.photo)try{const t=e.photo.startsWith("data:")?e.photo:`data:image/jpeg;base64,${e.photo}`;a.src=t,a.onerror=()=>setDefaultImage(a,e.category)}catch(t){console.error("Error processing image string:",t),setDefaultImage(a,e.category)}else setDefaultImage(a,e.category);a.alt=e.name||"Restaurant";const n=document.getElementById("restaurantTags");n.innerHTML="";const o=document.createElement("span");if(o.className="restaurant-tag primary",o.innerHTML=`${getCategoryIcon(e.category)} ${e.category}`,n.appendChild(o),e.tags&&"string"==typeof e.tags){e.tags.split(",").map(e=>e.trim()).filter(e=>e).slice(0,4).forEach(e=>{const t=document.createElement("span");t.className="restaurant-tag",t.textContent=e,n.appendChild(t)})}if(populateSchedule(e.hours),populateFeatures(e),e.company&&e.company.email){const e=document.getElementById("restaurantPhone");e.textContent="0721 234 567",e.href="tel:0721234567"}document.title=`${e.name} - AcoomH`}function setDefaultImage(e,t){const a={restaurant:"https://images.unsplash.com/photo-1555396273-367ea4eb4db5?ixlib=rb-4.0.3&auto=format&fit=crop&w=1000&q=80",cafe:"https://images.unsplash.com/photo-1501339847302-ac426a4a7cbb?ixlib=rb-4.0.3&auto=format&fit=crop&w=1000&q=80",pub:"https://images.unsplash.com/photo-1543007630-9710e4a00a20?ixlib=rb-4.0.3&auto=format&fit=crop&w=1000&q=80",club:"https://images.unsplash.com/photo-1470229722913-7c0e2dbbafd3?ixlib=rb-4.0.3&auto=format&fit=crop&w=1000&q=80"},n=t&&"string"==typeof t?t.toLowerCase():"restaurant";e.src=a[n]||a.restaurant}function populateSchedule(e){const t=document.getElementById("restaurantSchedule");t.innerHTML="";const a=(new Date).toLocaleDateString("ro-RO",{weekday:"long"}),n=a.charAt(0).toUpperCase()+a.slice(1),o=["Luni","Marți","Miercuri","Joi","Vineri","Sâmbătă","Duminică"];if(e&&e.length>0)o.forEach(a=>{const o=e.find(e=>e.dayOfWeek===a),r=document.createElement("div");r.className="schedule-item";const s=a===n,i=o?o.isClosed?"Închis":`${o.openTime} - ${o.closeTime}`:"Nedisponibil",c=!o||o.isClosed;r.innerHTML=`\n        <span class="schedule-day">${a}</span>\n        <span class="schedule-hours ${c?"closed":""} ${s?"current-day":""}">${i}</span>\n      `,t.appendChild(r)});else{const e={Luni:"10:00 - 22:00","Marți":"10:00 - 22:00",Miercuri:"10:00 - 22:00",Joi:"10:00 - 22:00",Vineri:"10:00 - 23:00","Sâmbătă":"10:00 - 23:00","Duminică":"12:00 - 21:00"};Object.entries(e).forEach(([e,a])=>{const o=document.createElement("div");o.className="schedule-item";const r=e===n;o.innerHTML=`\n        <span class="schedule-day">${e}</span>\n        <span class="schedule-hours ${r?"current-day":""}">${a}</span>\n      `,t.appendChild(o)})}}function populateFeatures(e){const t=document.getElementById("restaurantFeatures");t.innerHTML="";[{icon:"fas fa-credit-card",name:"Plată cu cardul"},{icon:"fas fa-calendar-check",name:"Rezervări online"},...{restaurant:[{icon:"fas fa-utensils",name:"Meniu variat"},{icon:"fas fa-users",name:"Pentru grupuri"}],cafe:[{icon:"fas fa-wifi",name:"WiFi gratuit"},{icon:"fas fa-coffee",name:"Cafea proaspătă"}],pub:[{icon:"fas fa-beer",name:"Bere la halba"},{icon:"fas fa-tv",name:"Transmisiuni live"}],club:[{icon:"fas fa-music",name:"Muzică live"},{icon:"fas fa-cocktail",name:"Cocktailuri"}]}[e.category&&"string"==typeof e.category?e.category.toLowerCase():"restaurant"]||[]].forEach(e=>{const a=document.createElement("div");a.className="feature-item",a.innerHTML=`\n      <i class="${e.icon}"></i>\n      <span>${e.name}</span>\n    `,t.appendChild(a)})}function getCategoryIcon(e){if(!e||"string"!=typeof e)return"fas fa-store";return{restaurant:"fas fa-utensils",cafe:"fas fa-coffee",pub:"fas fa-beer",club:"fas fa-music",bar:"fas fa-cocktail"}[e.toLowerCase()]||"fas fa-store"}function arrayBufferToBase64(e){let t="";const a=new Uint8Array(e),n=a.byteLength;for(let e=0;e<n;e++)t+=String.fromCharCode(a[e]);return window.btoa(t)}function initializeReservationForm(){const e=document.getElementById("reservationDate"),t=new Date,a=new Date;a.setDate(t.getDate()+30),e.min=t.toISOString().split("T")[0],e.max=a.toISOString().split("T")[0];const n=new Date;n.setDate(t.getDate()+1),e.value=n.toISOString().split("T")[0]}function validateReservationForm(){const e=document.getElementById("fullName").value.trim(),t=document.getElementById("phoneNumber").value.trim(),a=document.getElementById("reservationDate").value,n=document.getElementById("reservationTime").value,o=document.getElementById("guestCount").value,r=[];if(e?e.length<2&&r.push("Numele trebuie să aibă cel puțin 2 caractere"):r.push("Introdu numele tău complet"),t?/^(\+4|4|0)?\d{9}$/.test(t.replace(/\s/g,""))||r.push("Numărul de telefon nu este valid (ex: 0721234567)"):r.push("Introdu numărul de telefon"),a){const e=new Date(a),t=new Date;t.setHours(0,0,0,0),e<t&&r.push("Data rezervării nu poate fi în trecut")}else r.push("Selectează o dată pentru rezervare");return n||r.push("Selectează ora pentru rezervare"),o||r.push("Selectează numărul de persoane"),{isValid:0===r.length,errors:r}}function showPopup(e,t,a="fas fa-info-circle",n=!1){document.querySelectorAll(".popup-overlay").forEach(e=>e.remove());const o=document.createElement("div");o.className="popup-overlay";const r=document.createElement("div");function closePopup(){o.style.opacity="0",r.style.transform="scale(0.8) translateY(20px)",setTimeout(()=>{document.body.contains(o)&&document.body.removeChild(o)},300)}r.className="popup-content",r.innerHTML=`\n    <div style="margin-bottom: 25px;">\n      <i class="${a}" style="font-size: 3rem; color: ${n?"var(--success-color)":"var(--primary-color)"}; margin-bottom: 20px; display: block;"></i>\n      <h3>${e}</h3>\n      <p>${t}</p>\n    </div>\n    <button class="popup-close-btn">\n      <i class="fas fa-check" style="margin-right: 8px;"></i>\n      Înțeles!\n    </button>\n  `,r.querySelector(".popup-close-btn").addEventListener("click",closePopup),o.addEventListener("click",e=>{e.target===o&&closePopup()});const escapeHandler=e=>{"Escape"===e.key&&(closePopup(),document.removeEventListener("keydown",escapeHandler))};document.addEventListener("keydown",escapeHandler),o.appendChild(r),document.body.appendChild(o),setTimeout(()=>{o.style.opacity="1",r.style.transform="scale(1) translateY(0)"},10)}function setupFormValidation(){document.querySelectorAll(".form-input").forEach(e=>{e.addEventListener("blur",function(){validateInput(this)}),e.addEventListener("input",function(){this.classList.contains("error")&&validateInput(this)})})}function validateInput(e){const t=e.value;let a=!0,n="";if(e.hasAttribute("required")&&!t)a=!1,n="Acest câmp este obligatoriu";else if("date"===e.type&&t){const e=new Date(t),o=new Date;o.setHours(0,0,0,0),e<o&&(a=!1,n="Data nu poate fi în trecut")}const o=e.parentNode.querySelector(".error-message");if(o&&o.remove(),e.classList.remove("success","error"),a)t&&e.classList.add("success");else{e.classList.add("error");const t=document.createElement("div");t.className="error-message",t.textContent=n,e.parentNode.appendChild(t)}return a}function getCurrentRestaurant(){return currentLocation?{name:currentLocation.name,address:currentLocation.address,phone:"0721 234 567",cuisine:currentLocation.category}:{name:"Restaurant",address:"",phone:"0721 234 567",cuisine:"Restaurant"}}function initializeAnimations(){document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();const t=document.querySelector(this.getAttribute("href"));t&&t.scrollIntoView({behavior:"smooth",block:"start"})})});const e=new IntersectionObserver(e=>{e.forEach(e=>{e.isIntersecting&&e.target.classList.add("animate-in")})},{threshold:.1,rootMargin:"0px 0px -50px 0px"});document.querySelectorAll(".restaurant-section, .info-section, .reservation-section").forEach(t=>e.observe(t))}function initializeNavbar(){const e=document.querySelector(".navbar");if(e){let t=window.scrollY;window.addEventListener("scroll",()=>{const a=window.scrollY;a>100?e.classList.add("scrolled"):e.classList.remove("scrolled"),a>t&&a>200?e.classList.add("hidden"):e.classList.remove("hidden"),t=a})}const t=document.querySelector(".mobile-menu-toggle"),a=document.querySelector(".mobile-menu");t&&a&&t.addEventListener("click",()=>{a.classList.toggle("active"),t.classList.toggle("active")})}function initializeAll(){initializeReservationForm(),setupFormValidation(),initializeAnimations(),initializeNavbar()}document.addEventListener("DOMContentLoaded",function(){try{const e=getLocationId();if(!e)return void showError("ID-ul locației nu a fost găsit în URL.");loadLocationDetails(e),initializeAll(),"#reservation"===window.location.hash&&setTimeout(()=>{const e=document.querySelector(".reservation-section");e&&e.scrollIntoView({behavior:"smooth"})},1e3)}catch(e){console.error("Restaurant page initialization error:",e),showError("A apărut o problemă la încărcarea paginii.")}}),window.makeReservation=async function(){const e=validateReservationForm();if(!e.isValid)return void showPopup("Formular incomplet",e.errors.join("<br>"),"fas fa-exclamation-triangle");if(!currentLocation)return void showPopup("Eroare","Datele locației nu sunt disponibile. Te rugăm să reîmprospătezi pagina.","fas fa-exclamation-triangle");const t=document.getElementById("fullName").value.trim(),a=document.getElementById("phoneNumber").value.trim(),n=document.getElementById("reservationDate").value,o=document.getElementById("reservationTime").value,r=document.getElementById("guestCount").value,s={customerName:t,customerEmail:`${t.replace(/\s+/g,"").toLowerCase()}@temp.acoomh.ro`,customerPhone:a,reservationDate:n,reservationTime:o+":00",numberOfPeople:parseInt(r),locationId:parseInt(currentLocation.id),specialRequests:"",status:"Pending"},i=document.querySelector(".btn-rezerva"),c=i.innerHTML;i.disabled=!0,i.innerHTML='<div class="loading"></div> Se procesează...';try{await createReservation(s);i.disabled=!1,i.innerHTML=c;const e=new Date(n).toLocaleDateString("ro-RO",{weekday:"long",year:"numeric",month:"long",day:"numeric"});showPopup("Rezervare confirmată!",`Mulțumim, <strong>${t}</strong>!<br><br>Rezervarea ta la <strong>${currentLocation.name}</strong> pentru <strong>${e}</strong> la ora <strong>${o}</strong> pentru <strong>${r} ${"1"===r?"persoană":"persoane"}</strong> a fost trimisă!<br><br>Vei fi contactat în curând pentru confirmare.`,"fas fa-check-circle",!0),document.getElementById("fullName").value="",document.getElementById("phoneNumber").value="",document.getElementById("reservationDate").value="",document.getElementById("reservationTime").value="",document.getElementById("guestCount").value=""}catch(e){i.disabled=!1,i.innerHTML=c,showPopup("Eroare la rezervare",e.message||"Nu am putut procesa rezervarea. Te rugăm să încerci din nou.","fas fa-exclamation-triangle")}},window.callRestaurant=function(){const e=getCurrentRestaurant();e.phone&&(window.location.href=`tel:${e.phone}`)},window.openMaps=function(){const e=getCurrentRestaurant();if(e.address){const t=`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(e.address)}`;window.open(t,"_blank")}},window.shareRestaurant=function(){const e=getCurrentRestaurant(),t={title:e.name,text:`Descoperă ${e.name} pe AcoomH!`,url:window.location.href};function fallbackShare(){navigator.clipboard.writeText(window.location.href).then(()=>{showPopup("Link copiat!","Link-ul către restaurant a fost copiat în clipboard.","fas fa-copy",!0)}).catch(()=>{showPopup("Partajare",`Copiază acest link pentru a partaja restaurantul:<br><br><code style="background: var(--bg-dark); padding: 8px; border-radius: 6px; font-size: 0.8rem; word-break: break-all;">${window.location.href}</code>`,"fas fa-share-alt")})}navigator.share?navigator.share(t).catch(e=>{console.log("Error sharing:",e),fallbackShare()}):fallbackShare()},window.viewMenu=function(){showPopup("Meniu Restaurant",`Meniul pentru <strong>${getCurrentRestaurant().name}</strong> va fi disponibil în curând! <br><br>Pentru moment, poți suna la restaurant pentru a afla mai multe detalii despre preparatele disponibile.`,"fas fa-utensils")},window.goBack=function(){document.referrer&&document.referrer.includes(window.location.origin)?history.back():window.location.href="index.html"},initializeAll(),window.addEventListener("load",function(){document.body.classList.add("loaded")}),console.log("Restaurant page initialized successfully");const RestaurantUtils={formatPhoneNumber:function(e){return e.replace(/(\d{4})(\d{3})(\d{3})/,"$1 $2 $3")},isRestaurantOpen:function(e){const t=new Date,a=t.toLocaleDateString("ro-RO",{weekday:"long"}),n=a.charAt(0).toUpperCase()+a.slice(1),o=100*t.getHours()+t.getMinutes(),r=e[n];if(!r||r.toLowerCase().includes("închis"))return!1;const[s,i]=r.split(" - ").map(e=>{const[t,a]=e.split(":").map(Number);return 100*t+a});return o>=s&&o<=i},generateStarsHTML:function(e){const t=Math.floor(e),a=e%1!=0;let n="";for(let e=0;e<t;e++)n+='<i class="fas fa-star"></i>';a&&(n+='<i class="fas fa-star-half-alt"></i>');const o=5-Math.ceil(e);for(let e=0;e<o;e++)n+='<i class="far fa-star"></i>';return n}};